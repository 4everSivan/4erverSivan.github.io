(window.webpackJsonp=window.webpackJsonp||[]).push([[24],{304:function(t,a,s){"use strict";s.r(a);var e=s(14),r=Object(e.a)({},(function(){var t=this,a=t._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"数据库高可用部署"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#数据库高可用部署"}},[t._v("#")]),t._v(" 数据库高可用部署")]),t._v(" "),a("p",[t._v("[TOC]")]),t._v(" "),a("hr"),t._v(" "),a("h2",{attrs:{id:"_1-虚拟机相关信息"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-虚拟机相关信息"}},[t._v("#")]),t._v(" 1. 虚拟机相关信息")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("主机")]),t._v(" "),a("th",[t._v("地址")]),t._v(" "),a("th",[t._v("服务")]),t._v(" "),a("th",[t._v("zookeeper角色")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("b1")]),t._v(" "),a("td",[t._v("192.168.121.190")]),t._v(" "),a("td",[t._v("postgresql + zookeeper")]),t._v(" "),a("td",[t._v("follower")])]),t._v(" "),a("tr",[a("td",[t._v("b2")]),t._v(" "),a("td",[t._v("192.168.121.187")]),t._v(" "),a("td",[t._v("postgresql + zookeeper + pgbouncer + patroni （主库）")]),t._v(" "),a("td",[t._v("leader")])]),t._v(" "),a("tr",[a("td",[t._v("b3")]),t._v(" "),a("td",[t._v("192.168.121.189")]),t._v(" "),a("td",[t._v("postgresql + zookeeper + pgbouncer + patroni （备库）")]),t._v(" "),a("td",[t._v("follower")])])])]),t._v(" "),a("h2",{attrs:{id:"_2-版本信息"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-版本信息"}},[t._v("#")]),t._v(" 2. 版本信息")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("包名")]),t._v(" "),a("th",[t._v("版本")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("CentOS")]),t._v(" "),a("td",[t._v("7.9")])]),t._v(" "),a("tr",[a("td",[t._v("PostgreSQL")]),t._v(" "),a("td",[t._v("10.5")])]),t._v(" "),a("tr",[a("td",[t._v("Pgbouncer")]),t._v(" "),a("td",[t._v("1.8.1")])]),t._v(" "),a("tr",[a("td",[t._v("Zookeeper")]),t._v(" "),a("td",[t._v("3.4.13")])]),t._v(" "),a("tr",[a("td",[t._v("Patroni")]),t._v(" "),a("td",[t._v("1.4.4")])])])]),t._v(" "),a("blockquote",[a("p",[a("strong",[t._v("注意")]),t._v("：本部署方案已经完成了内核配置和数据库安装流程")])]),t._v(" "),a("h2",{attrs:{id:"_3-搭建主从数据库"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-搭建主从数据库"}},[t._v("#")]),t._v(" 3. 搭建主从数据库")]),t._v(" "),a("blockquote",[a("p",[t._v("在主库虚拟机上进行如下配置")])]),t._v(" "),a("h3",{attrs:{id:"_3-1-huge-pages配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-huge-pages配置"}},[t._v("#")]),t._v(" 3.1 huge pages配置")]),t._v(" "),a("ol",[a("li",[t._v("执行脚本 "),a("code",[t._v("calc-hugePages.sh")]),t._v("计算当前机器设置的页面数，脚本内容如下：")])]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#!/bin/bash")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("pid")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("`")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("head")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-1")]),t._v(" $PGDATA/postmaster.pid"),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("`")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Pid:            '),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$pid")]),t._v('"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("peak")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("`")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("grep")]),t._v(" ^VmPeak /proc/$pid/status "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("awk")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'{ print $2 }'")]),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("`")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"VmPeak:            '),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$peak")]),t._v(' kB"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("hps")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("`")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("grep")]),t._v(" ^Hugepagesize /proc/meminfo "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("awk")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'{ print $2 }'")]),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("`")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Hugepagesize:   '),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$hps")]),t._v(' kB"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("hp")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$((")]),t._v("peak"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("hps"),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("))")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" Set Huge Pages:     "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$hp")]),t._v("\n")])])]),a("ol",{attrs:{start:"2"}},[a("li",[t._v("将执行计算出的页面数设置到sysctl.conf中")])]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"vm.nr_hugepages = 147"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),t._v("/etc/sysctl.conf\n")])])]),a("ol",{attrs:{start:"3"}},[a("li",[t._v("查看是否设置成功")])]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sysctl")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-p")]),t._v("\n")])])]),a("ol",{attrs:{start:"4"}},[a("li",[t._v("修改数据库设置，开启对大页面的支持")])]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("vim")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$PGDATA")]),t._v("/postgresql.conf\n\thuge_pages "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" on\n")])])]),a("ol",{attrs:{start:"5"}},[a("li",[t._v("重启数据库")])]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("pg_ctl restart\n")])])]),a("h3",{attrs:{id:"_3-2-配置流复制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-配置流复制"}},[t._v("#")]),t._v(" 3.2 配置流复制")]),t._v(" "),a("blockquote",[a("p",[t._v("主库配置")])]),t._v(" "),a("ol",[a("li",[t._v("配置允许访问的ip")])]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(". 切换目录\n \t"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$PGDATA")]),t._v("\n \n "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(".备份pg_hba.conf文件\n \t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("cp")]),t._v(" pg_hba.conf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(",.bak"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n \n "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(". 修改pg_hba.conf，修改pg_hba.conf参数，如主从复制的主库加入用户replicate、从库的ip"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".6.22/24"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n \t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("vim")]),t._v(" pg_hba.conf\n\t "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 添加如下配置")]),t._v("\n \t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("host")]),t._v("    replication     replicate      "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".121.189/24          trust\n \n "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v(". 重启\n\tpg_ctl restart \n \n")])])]),a("ol",{attrs:{start:"2"}},[a("li",[t._v("登录pg修改密码并创建用户")])]),t._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("alter")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("user")]),t._v(" postgres "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("with")]),t._v(" password "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'postgres'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("create")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("user")]),t._v(" replicate "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("with")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("replication")]),t._v(" password "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'replicate'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("blockquote",[a("p",[t._v("从库配置")])]),t._v(" "),a("ol",[a("li",[t._v("使用 pgbasebackup 工具生成备库")])]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("pg_basebackup "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-D")]),t._v(" /home/postgres/pgdata "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-R")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-Fp")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-Xs")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-v")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-P")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-h")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".6.52 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-p")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5432")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-U")]),t._v(" replicate\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# pgdata目录修改为自己的机器上的位置")]),t._v("\n")])])]),a("ol",{attrs:{start:"2"}},[a("li",[t._v("启动备数据库，需提前将配置文件中的huge_pages关闭")])]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("vim")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$PGDATA")]),t._v("/postgresql.conf\nhuge_pages "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" off\n")])])]),a("ol",{attrs:{start:"3"}},[a("li",[t._v("启动数据库")])]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("pg_ctl start\n")])])]),a("ol",{attrs:{start:"4"}},[a("li",[t._v("运行"),a("code",[t._v("calc-hugePages.sh")]),t._v("程序，同样和主库一样获取"),a("code",[t._v("huge_pages")]),t._v("的值，然后写入到"),a("code",[t._v("sysctl.conf")])])]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("./calc-hugePages.sh\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"vm.nr_hugepages = 147"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),t._v("/etc/sysctl.conf\n")])])]),a("ol",{attrs:{start:"5"}},[a("li",[t._v("查询是否添加成功")])]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sysctl")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-p")]),t._v("\n")])])]),a("ol",{attrs:{start:"6"}},[a("li",[t._v("重启数据库")])]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("pg_ctl restart\n")])])]),a("h3",{attrs:{id:"_3-3-验证主从复制是否成功"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-验证主从复制是否成功"}},[t._v("#")]),t._v(" 3.3 验证主从复制是否成功")]),t._v(" "),a("blockquote",[a("p",[t._v("主库登录检验")])]),t._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[t._v("psql\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("select")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" pg_stat_replication "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\t\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 查看复制状态")]),t._v("\n")])])]),a("p",[a("img",{attrs:{src:"http://img.sweetbabywow.club/typoara/image-20220811152017867.png",alt:"image-20220811152017867"}})]),t._v(" "),a("h2",{attrs:{id:"_4-安装pgbouncer"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-安装pgbouncer"}},[t._v("#")]),t._v(" 4. 安装pgbouncer")]),t._v(" "),a("h3",{attrs:{id:"_4-1-部署情况"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-部署情况"}},[t._v("#")]),t._v(" 4.1 部署情况")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("服务器ip")]),t._v(" "),a("th",[t._v("部署情况")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("192.168.121.187（主库）")]),t._v(" "),a("td",[t._v("pgbouncer")])]),t._v(" "),a("tr",[a("td",[t._v("192.168.121.189（备库）")]),t._v(" "),a("td",[t._v("pgbouncer")])])])]),t._v(" "),a("h3",{attrs:{id:"_4-2-相关依赖"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-相关依赖"}},[t._v("#")]),t._v(" 4.2 相关依赖")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("包名")]),t._v(" "),a("th",[t._v("版本")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("libevent")]),t._v(" "),a("td",[t._v("2.0.21")])]),t._v(" "),a("tr",[a("td",[t._v("pgbouncer")]),t._v(" "),a("td",[t._v("1.8.1")])])])]),t._v(" "),a("h3",{attrs:{id:"_4-3-安装libevent"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-安装libevent"}},[t._v("#")]),t._v(" 4.3 安装libevent")]),t._v(" "),a("blockquote",[a("p",[t._v("在root用户下安装")])]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(". 解压安装\n\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" /usr/libevent\n\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("tar")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-zvxf")]),t._v(" libevent-2.0.21-stable.tar.gz \n\t"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" libevent-2.0.21-stable\n\t./configure "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--prefix")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/usr/libevent\n\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("make")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-j4")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("make")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-j4")]),t._v("\n")])])]),a("h3",{attrs:{id:"_4-4-安装pgbouncer"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-4-安装pgbouncer"}},[t._v("#")]),t._v(" 4.4 安装Pgbouncer")]),t._v(" "),a("blockquote",[a("p",[t._v("在postgres用户下安装")])]),t._v(" "),a("ol",[a("li",[t._v("解压安装（在/home/postgres目录下）")])]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("tar")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-zvxf")]),t._v(" pgbouncer-1.8.1.tar.gz\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" pgbouncer-1.8.1\n./configure "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--prefix")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/home/postgres/pgbouncer --with-libevent"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/usr/libevent/\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("make")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-j4")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("make")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-j4")]),t._v("\n")])])]),a("ol",{attrs:{start:"2"}},[a("li",[t._v("手动创建log目录")])]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" /home/postgres/pgbouncer/log\n")])])]),a("p",[t._v("​\t3. 修改配置文件")]),t._v(" "),a("div",{staticClass:"language-ini extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ini"}},[a("code",[t._v("vi /home/postgres/pgbouncer/share/doc/pgbouncer/pgbouncer.ini\n\n"),a("span",{pre:!0,attrs:{class:"token section"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token section-name selector"}},[t._v("databases")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("postgres")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("host=172.16.245.4 port=7432 user=postgres password=postgresql pool_size=20")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("postgres")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("host=172.16.245.5 port=7432 user=postgres password=postgresql pool_size=20")]),t._v("\n\n\n"),a("span",{pre:!0,attrs:{class:"token section"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token section-name selector"}},[t._v("pgbouncer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("listen_port")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("6432")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("listen_addr")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("*")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v(";unix_socket_dir = ''")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v(";user = postgres")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("auth_type")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("md5")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("auth_file")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("/home/postgres/pgbouncer/share/doc/pgbouncer/userlist.txt")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("logfile")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("/home/postgres/pgbouncer/log/pgbouncer.log")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("pidfile")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("/home/postgres/pgbouncer/log/pgbouncer.pid")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("admin_users")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("postgres")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("stats_users")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("mon")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("pool_mode")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("session")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("client_idle_timeout")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("10")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("server_idle_timeout")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("1800")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("idle_transaction_timeout")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("10")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("client_login_timeout")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("10")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("server_reset_query")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("DEALLOCATE ALL;")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("server_check_query")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("select 1")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("server_check_delay")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("10")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("reserve_pool_size")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("5")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("reserve_pool_timeout")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("5")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("max_client_conn")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("50")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("default_pool_size")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("20")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("log_connections")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("0")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("log_disconnections")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("0")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("log_pooler_errors")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("1")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("ignore_startup_parameters")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("extra_float_digits")]),t._v('\n\nvi userlist.txt\n"postgres" "postgresql"\n')])])]),a("ol",{attrs:{start:"4"}},[a("li",[t._v("启动服务")])]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("/home/postgres/pgbouncer/bin/pgbouncer "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-d")]),t._v(" pgbouncer/share/doc/pgbouncer/pgbouncer.ini \n")])])]),a("p",[t._v("​\t启动报错：pgbouncer: error while loading shared libraries: libevent-2.0.so.5: cannot open shared object file: No such file or directory解决方案如下:")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 添加至全局变量文件中")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("su")]),t._v(" - \n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("vi")]),t._v(" /etc/profile\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("export")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("LD_LIBRARY_PATH")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/usr/libevent/lib:"),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$LD_LIBRARY_PATH")]),t._v("   \n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("source")]),t._v(" /etc/profile\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 或者添加至用户变量 .bash_profile")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("export")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("PKG_CONFIG_PATH")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/home/postgres/libevent/lib/pkgconfig\n")])])]),a("ol",{attrs:{start:"5"}},[a("li",[a("p",[t._v("查看日志信息和服务器启动情况")]),t._v(" "),a("p",[t._v("日志信息如下："),a("code",[t._v("tail -f pgbouncer/log/pgbouncer.log")])])])]),t._v(" "),a("p",[a("img",{attrs:{src:"http://img.sweetbabywow.club/typoara/image-20220811160122697.png",alt:"image-20220811160122697"}})]),t._v(" "),a("p",[t._v("​\t查看服务状态："),a("code",[t._v("ps -elf |grep pgbouncer")])]),t._v(" "),a("p",[a("img",{attrs:{src:"http://img.sweetbabywow.club/typoara/image-20220811160358529.png",alt:"image-20220811160358529"}})]),t._v(" "),a("ol",{attrs:{start:"6"}},[a("li",[t._v("确认是否可以登录")])]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("psql "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-h")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".121.189 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-p")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6432")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-d")]),t._v(" pgbouncer "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-U")]),t._v(" postgres\n")])])]),a("p",[a("img",{attrs:{src:"http://img.sweetbabywow.club/typoara/image-20220811160704665.png",alt:"image-20220811160704665"}})]),t._v(" "),a("ol",{attrs:{start:"7"}},[a("li",[t._v("查看池中的数据库 "),a("code",[t._v("show databases;")])])]),t._v(" "),a("p",[a("img",{attrs:{src:"http://img.sweetbabywow.club/typoara/image-20220811160753521.png",alt:"image-20220811160753521"}})]),t._v(" "),a("ol",{attrs:{start:"6"}},[a("li",[t._v("查看连接数"),a("code",[t._v("show clients;")])])]),t._v(" "),a("p",[a("img",{attrs:{src:"http://img.sweetbabywow.club/typoara/image-20220811160832985.png",alt:"image-20220811160832985"}})]),t._v(" "),a("h2",{attrs:{id:"_5-安装zookeeper"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-安装zookeeper"}},[t._v("#")]),t._v(" 5. 安装Zookeeper")]),t._v(" "),a("h3",{attrs:{id:"_5-1-部署情况"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-部署情况"}},[t._v("#")]),t._v(" 5.1 部署情况")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("服务器ip")]),t._v(" "),a("th",[t._v("模式")]),t._v(" "),a("th",[t._v("myid")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("192.168.121.187")]),t._v(" "),a("td",[t._v("master")]),t._v(" "),a("td",[t._v("3")])]),t._v(" "),a("tr",[a("td",[t._v("192.168.121.189")]),t._v(" "),a("td",[t._v("follower")]),t._v(" "),a("td",[t._v("2")])]),t._v(" "),a("tr",[a("td",[t._v("192.168.121.190")]),t._v(" "),a("td",[t._v("follower")]),t._v(" "),a("td",[t._v("1")])])])]),t._v(" "),a("h3",{attrs:{id:"_5-2-下载路径及所装版本"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-下载路径及所装版本"}},[t._v("#")]),t._v(" 5.2 下载路径及所装版本")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("Zookeeper下载路径")]),t._v(" "),a("th",[t._v("https://archive.apache.org/dist/zookeeper/zookeeper-3.4.13/zookeeper-3.4.13.tar.gz")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("Zookeeper 版本")]),t._v(" "),a("td",[t._v("zookeeper-3.4.13.tar.gz")])])])]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("Java下载路径")]),t._v(" "),a("th",[t._v("https://www.oracle.com/java/technologies/downloads/#java8")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("Java 版本")]),t._v(" "),a("td",[t._v("jdk-8u341-linux-x64.tar.gz")])])])]),t._v(" "),a("h3",{attrs:{id:"_5-3-安装java环境"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-3-安装java环境"}},[t._v("#")]),t._v(" 5.3 安装Java环境")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 创建目录")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" /usr/java\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 解压")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("tar")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-zvxf")]),t._v(" jdk-8u341-linux-x64.tar.gz "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-C")]),t._v(" /usr/java/\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 添加环境变量")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("vi")]),t._v(" /etc/profile\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#set java environment")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("JAVA_HOME")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/usr/java/jdk1.8.0_341\n        "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("JRE_HOME")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/usr/java/jdk1.8.0_341/jre\n        "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("CLASS_PATH")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(".:"),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$JAVA_HOME")]),t._v("/lib/dt.jar:"),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$JAVA_HOME")]),t._v("/lib/tools.jar:"),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$JRE_HOME")]),t._v("/lib\n        "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a("span",{pre:!0,attrs:{class:"token environment constant"}},[t._v("PATH")])]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token environment constant"}},[t._v("$PATH")]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$JAVA_HOME")]),t._v("/bin:"),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$JRE_HOME")]),t._v("/bin\n        "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("export")]),t._v(" JAVA_HOME JRE_HOME CLASS_PATH "),a("span",{pre:!0,attrs:{class:"token environment constant"}},[t._v("PATH")]),t._v("\n    \n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 重新加载环境变量")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("source")]),t._v(" /etc/profile\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 测试")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("java")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-version")]),t._v("\n")])])]),a("h3",{attrs:{id:"_5-4-解压安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-4-解压安装"}},[t._v("#")]),t._v(" 5.4 解压安装")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 安装目录 /home/postgres/zookeeper-3.4.13")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("tar")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-zxvf")]),t._v(" zookeeper-3.4.13.tar.gz\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 拷贝zoo.cfg")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" /home/postgres/zookeeper-3.4.13/conf\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("cp")]),t._v(" zoo.sample.cfg zoo.cfg\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 修改配置文件")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("vim")]),t._v(" zoo.cfg\n        "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("tickTime")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2000")]),t._v("\n        server.1 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".121.189:2888:3888\n        server.2 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".121.190:2888:3888\n        server.3 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".121.187:2888:3888\n        "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("initLimit")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("syncLimit")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("dataDir")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/home/postgres/zookeeper-3.4.13/data\n        "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("clientPort")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2181")]),t._v("\n        \n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 创建 data log 目录")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" /home/postgres/zookeeper-3.4.13/data\n\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" /home/postgres/zookeeper-3.4.13/log\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 创建 myid 文件 值越高选取为leader的优先级也越高")]),t._v("\n\t\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 在192.168.121.187（主库）中")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" /home/postgres/zookeeper-3.4.13/data/myid\n\t\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 在192.168.121.189（备库）中")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" /home/postgres/zookeeper-3.4.13/data/myid\n\t\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 在192.168.121.190中")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" /home/postgres/zookeeper-3.4.13/data/myid\n\t\n\t\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 为防火墙添加端口")]),t._v("\n\tfirewall-cmd "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--permanent")]),t._v(" --add-port"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2888")]),t._v("/tcp\n\tfirewall-cmd "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--permanent")]),t._v(" --add-port"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3888")]),t._v("/tcp\n\tfirewall-cmd "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--permanent")]),t._v(" --add-port"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2181")]),t._v("/tcp\n\tfirewall-cmd "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--reload")]),t._v("\n\t\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 启动服务 (需要三台服务器启动服务)")]),t._v("\n\t/home/postgres/zookeeper-3.4.13/bin/zkServer.sh start\n\t\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 查看服务状态")]),t._v("\n\t/home/postgres/zookeeper-3.4.13/bin/zkServer.sh status\n\t\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 停止服务")]),t._v("\n\t/home/postgres/zookeeper-3.4.13/bin/zkServer.sh stop\n\t\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 重启服务")]),t._v("\n\t/home/postgres/zookeeper-3.4.13/bin/zkServer.sh restart\n\t\n* 日志请在运行启动命令的目录下查看zookeeper.out文件\n")])])]),a("p",[t._v("安装完成后服务状态如下：")]),t._v(" "),a("ul",[a("li",[t._v("主库")])]),t._v(" "),a("p",[a("img",{attrs:{src:"http://img.sweetbabywow.club/typoara/image-20220812095438240.png",alt:"image-20220812095438240"}})]),t._v(" "),a("ul",[a("li",[t._v("从库")])]),t._v(" "),a("p",[a("img",{attrs:{src:"http://img.sweetbabywow.club/typoara/image-20220812095733912.png",alt:"image-20220812095733912"}})]),t._v(" "),a("h2",{attrs:{id:"_6-安装patroni"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-安装patroni"}},[t._v("#")]),t._v(" 6. 安装Patroni")]),t._v(" "),a("h3",{attrs:{id:"_6-1-部署情况"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-1-部署情况"}},[t._v("#")]),t._v(" 6.1 部署情况")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("服务器ip")]),t._v(" "),a("th",[t._v("服务")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("192.168.121.187")]),t._v(" "),a("td",[t._v("patroni")])]),t._v(" "),a("tr",[a("td",[t._v("192.168.121.189")]),t._v(" "),a("td",[t._v("patroni")])])])]),t._v(" "),a("h3",{attrs:{id:"_6-2-相关依赖"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-2-相关依赖"}},[t._v("#")]),t._v(" 6.2 相关依赖")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("patroni下载地址")]),t._v(" "),a("th",[t._v("https://codeload.github.com/zalando/patroni/zip/1de7c78c04dab9882f6113815d377e6f3490d5dd")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("patroni版本")]),t._v(" "),a("td",[t._v("patroni-1.4.4.zip")])])])]),t._v(" "),a("h3",{attrs:{id:"_6-3-部署前准备"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-3-部署前准备"}},[t._v("#")]),t._v(" 6.3 部署前准备")]),t._v(" "),a("ol",[a("li",[t._v("安装python相关包")])]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("yum "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-y")]),t._v(" gcc epel-release\nyum "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-y")]),t._v(" python-pip python-psycopg2 python-devel\n\nyum "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-y")]),t._v(" python3-pip\nyum "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-y")]),t._v(" python36-devel\n\npip3 "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-upgrade")]),t._v(" pip\n")])])]),a("ol",{attrs:{start:"2"}},[a("li",[t._v("pip安装相关依赖")])]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("pip3 "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" urllib3 boto  psycopg2  requests  PyYAML six kazoo python-etcd python-consul  click prettytable  tzlocal python-dateutil psutil cdiff kubernetes psycopg2-binary patroni\n")])])]),a("blockquote",[a("p",[t._v("在本步骤出现Time out报错的时候，大多数情况是因为网络原因导致的")])]),t._v(" "),a("h3",{attrs:{id:"_6-4-解压安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-4-解压安装"}},[t._v("#")]),t._v(" 6.4 解压安装")]),t._v(" "),a("blockquote",[a("p",[t._v("使用postgres用户进行解压安装")])]),t._v(" "),a("ol",[a("li",[t._v("wget下载的包名需要进行修改")])]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("wget")]),t._v(" https://codeload.github.com/zalando/patroni/zip/1de7c78c04dab9882f6113815d377e6f3490d5dd\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("mv")]),t._v(" 1de7c78c04dab9882f6113815d377e6f3490d5dd patroni-1.4.4.zip\n")])])]),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[t._v("2. 压缩格式为zip,需要安装unzip解压工具\n")])])]),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("yum "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-y")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("unzip")]),t._v("\n")])])]),a("ol",{attrs:{start:"3"}},[a("li",[t._v("解压安装（路径为/home/postgres/）")])]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 解压")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("unzip")]),t._v(" partoni-1.4.4.zip\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 修改 postgres0.yml 配置文件")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" patroni-1.4.4.zip\n\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("vi")]),t._v(" postgres0.yml\n\t\tscope: batmant1\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#namespace: /service/")]),t._v("\n        name: node_192_168_121_187\n\n        restapi:\n          listen: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".121.187:8009\n          connect_address: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".121.187:8009\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#  certfile: /etc/ssl/certs/ssl-cert-snakeoil.pem")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#  keyfile: /etc/ssl/private/ssl-cert-snakeoil.key")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#  authentication:")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#    username: username")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#    password: password")]),t._v("\n\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# ctl:")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#   insecure: false # Allow connections to SSL sites without certs")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#   certfile: /etc/ssl/certs/ssl-cert-snakeoil.pem")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#   cacert: /etc/ssl/certs/ssl-cacert-snakeoil.pem")]),t._v("\n\n        zookeeper:\n          hosts: "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'192.168.121.187:2181,192.168.121.189:2181,192.168.121.190:2181'")]),t._v("\n\n        bootstrap:\n          "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# this section will be written into Etcd:/<namespace>/<scope>/config after initializing new cluster")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# and all other cluster members will use it as a `global configuration`")]),t._v("\n          dcs:\n            ttl: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("30")]),t._v("\n            loop_wait: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v("\n            retry_timeout: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v("\n            maximum_lag_on_failover: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1048576")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#    master_start_timeout: 300")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#    synchronous_mode: false")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#    standby_cluster:")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#      host: 192.168.191.143")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#      port: 5432")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#      primary_slot_name: node_192_168_191_141_ss")]),t._v("\n            postgresql:\n              use_pg_rewind: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#      use_slots: true")]),t._v("\n              parameters:\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#       shared_preload_libraries: 'pg_pathman'")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#        wal_level: hot_standby")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v('#        hot_standby: "on"')]),t._v("\n                wal_keep_segments: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),t._v("\n                max_wal_senders: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v("\n                max_replication_slots: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v('#        wal_log_hints: "on"')]),t._v("\n               max_connections: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),t._v("\n               archive_mode: "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"off"')]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#        archive_timeout: 1800s")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#        archive_command: mkdir -p ../wal_archive && test ! -f ../wal_archive/%f && cp %p ../wal_archive/%f")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#      recovery_conf:")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#        restore_command: cp ../wal_archive/%f %p")]),t._v("\n\n          "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# some desired options for 'initdb'")]),t._v("\n          initdb:  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Note: It needs to be a list (some options need values, others are switches)")]),t._v("\n          - encoding: UTF8\n          - data-checksums\n\n          pg_hba:  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Add following lines to pg_hba.conf after running 'initdb'")]),t._v("\n          - "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("host")]),t._v(" replication replicate "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),t._v(".0.1/32 trust\n          - "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("host")]),t._v(" all all "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.0")]),t._v(".0.0/0 md5\n          - "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("host")]),t._v(" replication all "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".121.189/32 trust\n          - "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("host")]),t._v(" replication all "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".121.187/32 trust \n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#  - hostssl all all 0.0.0.0/0 md5")]),t._v("\n\n          "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Additional script to be launched after initial cluster creation (will be passed the connection URL as parameter)")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# post_init: /usr/local/bin/setup_cluster.sh")]),t._v("\n\n          "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Some additional users users which needs to be created after initializing new cluster")]),t._v("\n          users:\n            admin:\n              password: admin\n              options:\n                - createrole\n                - createdb\n\n        postgresql:\n          listen: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.0")]),t._v(".0.0:5432\n          connect_address: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".121.187:5432\n          data_dir: /data/pgsql/10.5/pgdata/\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#  bin_dir:")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#  config_dir:")]),t._v("\n          pgpass: /home/postgres/.pgpass\n          authentication:\n            replication:\n              username: replicate\n              password: "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'replicate'")]),t._v("\n            superuser:\n              username: postgres\n              password: "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'postgresql'")]),t._v("\n          parameters:\n            unix_socket_directories: "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/home/postgres'")]),t._v("\n\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#watchdog:")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#  mode: automatic # Allowed values: off, automatic, required")]),t._v("\n        mode: off\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#  device: /dev/watchdog")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#  safety_margin: 5")]),t._v("\n\n        tags:\n            nofailover: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n            noloadbalance: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n            clonefrom: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n            nosync: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n")])])]),a("h3",{attrs:{id:"_6-5-启动patroni服务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-5-启动patroni服务"}},[t._v("#")]),t._v(" 6.5 启动Patroni服务")]),t._v(" "),a("ol",[a("li",[t._v("后台启动")])]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("nohup")]),t._v(" patroni postgres0.yml "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" postgres0.log "),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[t._v("2")]),t._v(">")]),a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[t._v("&1")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("\n")])])]),a("ol",{attrs:{start:"2"}},[a("li",[t._v("查看服务状态")])]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ps")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-ef")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("grep")]),t._v(" patroni\n")])])]),a("blockquote",[a("p",[t._v("日志文件保存在postgres0.log中")])]),t._v(" "),a("h4",{attrs:{id:"_6-5-1-追踪日志信息"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-5-1-追踪日志信息"}},[t._v("#")]),t._v(" 6.5.1 追踪日志信息")]),t._v(" "),a("ul",[a("li",[t._v("主库")])]),t._v(" "),a("p",[a("img",{attrs:{src:"http://img.sweetbabywow.club/typoara/image-20220812100205912.png",alt:"image-20220812100205912"}})]),t._v(" "),a("ul",[a("li",[t._v("备库")])]),t._v(" "),a("p",[a("img",{attrs:{src:"http://img.sweetbabywow.club/typoara/image-20220812100243352.png",alt:"image-20220812100243352"}})]),t._v(" "),a("h4",{attrs:{id:"_6-5-2-常见问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-5-2-常见问题"}},[t._v("#")]),t._v(" 6.5.2 常见问题")]),t._v(" "),a("p",[t._v("在postgres0.log中可以看到启动及错误信息，")]),t._v(" "),a("ul",[a("li",[t._v("如出现refuse connection 首先检查配置文件中的服务端口8009是否在防护墙放行。")]),t._v(" "),a("li",[t._v("出现pg相关的报错检查pg数据库是否启动，配置文件中的相关信息是否正确。")]),t._v(" "),a("li",[t._v("出现python相关的报错检查相关依赖是否安装和升级。")])]),t._v(" "),a("h3",{attrs:{id:"_6-6-patroni-主备切换"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-6-patroni-主备切换"}},[t._v("#")]),t._v(" 6.6 Patroni 主备切换")]),t._v(" "),a("h4",{attrs:{id:"_6-6-1-查看patroni主备信息"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-6-1-查看patroni主备信息"}},[t._v("#")]),t._v(" 6.6.1 查看patroni主备信息")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("patronictl "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-c")]),t._v(" /home/postgres/patroni-1.4.4/postgres0.yml list batmant1\n")])])]),a("p",[a("img",{attrs:{src:"http://img.sweetbabywow.club/typoara/image-20220812100453567.png",alt:"image-20220812100453567"}})]),t._v(" "),a("h4",{attrs:{id:"_6-6-2-手动进行主备切换"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-6-2-手动进行主备切换"}},[t._v("#")]),t._v(" 6.6.2 手动进行主备切换")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("patronictl "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-c")]),t._v(" /home/postgres/patroni-1.4.4/postgres0.yml switchover\n")])])]),a("p",[a("img",{attrs:{src:"http://img.sweetbabywow.club/typoara/image-20220812100727716.png",alt:"image-20220812100727716"}})]),t._v(" "),a("h4",{attrs:{id:"_6-2-3-查看切换信息"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-2-3-查看切换信息"}},[t._v("#")]),t._v(" 6.2.3 查看切换信息")]),t._v(" "),a("ul",[a("li",[t._v("查看主库的状态（已经转为备库）")])]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("pg_controldata "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("grep")]),t._v(" state\n")])])]),a("p",[a("img",{attrs:{src:"http://img.sweetbabywow.club/typoara/image-20220812105240145.png",alt:"image-20220812105240145"}})]),t._v(" "),a("ul",[a("li",[t._v("查看备库的状态（已经转为主库）")])]),t._v(" "),a("p",[a("img",{attrs:{src:"http://img.sweetbabywow.club/typoara/image-20220812105849631.png",alt:"image-20220812105849631"}})])])}),[],!1,null,null,null);a.default=r.exports}}]);