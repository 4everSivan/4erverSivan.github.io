<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Patroni | Sivan Page</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/assets/css/0.styles.8f3dca9f.css" as="style"><link rel="preload" href="/assets/js/app.4e56e56e.js" as="script"><link rel="preload" href="/assets/js/2.3dc1b8de.js" as="script"><link rel="preload" href="/assets/js/1.7f771cfb.js" as="script"><link rel="preload" href="/assets/js/23.79c4ee49.js" as="script"><link rel="prefetch" href="/assets/js/10.23a1f579.js"><link rel="prefetch" href="/assets/js/11.c389195a.js"><link rel="prefetch" href="/assets/js/12.1d996921.js"><link rel="prefetch" href="/assets/js/13.4d4410c4.js"><link rel="prefetch" href="/assets/js/14.37ef2a72.js"><link rel="prefetch" href="/assets/js/15.5542c093.js"><link rel="prefetch" href="/assets/js/16.d48fd1ce.js"><link rel="prefetch" href="/assets/js/17.bd8d538c.js"><link rel="prefetch" href="/assets/js/18.6d3b94c1.js"><link rel="prefetch" href="/assets/js/19.eb35cfee.js"><link rel="prefetch" href="/assets/js/20.c11ec329.js"><link rel="prefetch" href="/assets/js/21.db1b5d88.js"><link rel="prefetch" href="/assets/js/22.6916f4ef.js"><link rel="prefetch" href="/assets/js/24.f176594d.js"><link rel="prefetch" href="/assets/js/25.00acdf15.js"><link rel="prefetch" href="/assets/js/26.9b34ee88.js"><link rel="prefetch" href="/assets/js/27.2a70b75b.js"><link rel="prefetch" href="/assets/js/28.d18ecdb6.js"><link rel="prefetch" href="/assets/js/29.91511347.js"><link rel="prefetch" href="/assets/js/3.5322f14a.js"><link rel="prefetch" href="/assets/js/30.1fba689d.js"><link rel="prefetch" href="/assets/js/4.84e1e480.js"><link rel="prefetch" href="/assets/js/5.f0541060.js"><link rel="prefetch" href="/assets/js/6.dfb06aa0.js"><link rel="prefetch" href="/assets/js/7.7551a9fb.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.5e19b665.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8f3dca9f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Sivan Page</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程语言" class="dropdown-title"><span class="title">编程</span> <span class="arrow down"></span></button> <button type="button" aria-label="编程语言" class="mobile-dropdown-title"><span class="title">编程</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/python/Python3.10安装.html" class="nav-link">
  Python
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/mysql/MySQL简介.html" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/sql_server/" class="nav-link">
  SQL Server
</a></li><li class="dropdown-item"><!----> <a href="/pg/PostgreSQL简介.html" class="nav-link">
  PostgreSQL
</a></li><li class="dropdown-item"><!----> <a href="/ha/数据库高可用部署.html" class="nav-link">
  HA
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="运维" class="dropdown-title"><span class="title">运维</span> <span class="arrow down"></span></button> <button type="button" aria-label="运维" class="mobile-dropdown-title"><span class="title">运维</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/linux/Linux简介.html" class="nav-link">
  Linux
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="文章" class="dropdown-title"><span class="title">文章</span> <span class="arrow down"></span></button> <button type="button" aria-label="文章" class="mobile-dropdown-title"><span class="title">文章</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/translation/" class="nav-link">
  翻译
</a></li><li class="dropdown-item"><!----> <a href="/day_log/" class="nav-link">
  杂记
</a></li><li class="dropdown-item"><!----> <a href="/write_log/随笔.html" class="nav-link">
  随笔
</a></li></ul></div></div><div class="nav-item"><a href="/me/" class="nav-link">
  关于我
</a></div><div class="nav-item"><a href="https://github.com/4everSivan" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程语言" class="dropdown-title"><span class="title">编程</span> <span class="arrow down"></span></button> <button type="button" aria-label="编程语言" class="mobile-dropdown-title"><span class="title">编程</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/python/Python3.10安装.html" class="nav-link">
  Python
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/mysql/MySQL简介.html" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/sql_server/" class="nav-link">
  SQL Server
</a></li><li class="dropdown-item"><!----> <a href="/pg/PostgreSQL简介.html" class="nav-link">
  PostgreSQL
</a></li><li class="dropdown-item"><!----> <a href="/ha/数据库高可用部署.html" class="nav-link">
  HA
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="运维" class="dropdown-title"><span class="title">运维</span> <span class="arrow down"></span></button> <button type="button" aria-label="运维" class="mobile-dropdown-title"><span class="title">运维</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/linux/Linux简介.html" class="nav-link">
  Linux
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="文章" class="dropdown-title"><span class="title">文章</span> <span class="arrow down"></span></button> <button type="button" aria-label="文章" class="mobile-dropdown-title"><span class="title">文章</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/translation/" class="nav-link">
  翻译
</a></li><li class="dropdown-item"><!----> <a href="/day_log/" class="nav-link">
  杂记
</a></li><li class="dropdown-item"><!----> <a href="/write_log/随笔.html" class="nav-link">
  随笔
</a></li></ul></div></div><div class="nav-item"><a href="/me/" class="nav-link">
  关于我
</a></div><div class="nav-item"><a href="https://github.com/4everSivan" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/python/Python3.10安装" class="sidebar-heading clickable"><span>Python</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/linux/Linux简介" class="sidebar-heading clickable"><span>Linux</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/pg/PostgreSQL简介" class="sidebar-heading clickable"><span>PostgreSQL</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/mysql/MySQL简介" class="sidebar-heading clickable"><span>MySQL</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/ha/数据库高可用部署" class="sidebar-heading clickable open"><span>HA</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/ha/数据库高可用部署.html" class="sidebar-link">数据库高可用部署</a></li><li><a href="/ha/Patroni总结.html" class="active sidebar-link">Patroni</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/ha/Patroni总结.html#环境" class="sidebar-link">环境</a></li><li class="sidebar-sub-header"><a href="/ha/Patroni总结.html#watchdog" class="sidebar-link">watchdog</a></li><li class="sidebar-sub-header"><a href="/ha/Patroni总结.html#postgresql" class="sidebar-link">PostgreSQL</a></li><li class="sidebar-sub-header"><a href="/ha/Patroni总结.html#config" class="sidebar-link">Config</a></li><li class="sidebar-sub-header"><a href="/ha/Patroni总结.html#dcs" class="sidebar-link">DCS</a></li><li class="sidebar-sub-header"><a href="/ha/Patroni总结.html#ha" class="sidebar-link">HA</a></li><li class="sidebar-sub-header"><a href="/ha/Patroni总结.html#switchover-failover" class="sidebar-link">Switchover &amp; Failover</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/write_log/随笔" class="sidebar-heading clickable"><span>随笔</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="patroni"><a href="#patroni" class="header-anchor">#</a> Patroni</h1> <p>[TOC]</p> <h2 id="环境"><a href="#环境" class="header-anchor">#</a> 环境</h2> <p>软件版本：</p> <ul><li>Patroni: <code>3.0.2</code></li> <li>Python: <code>3.9.16</code></li> <li>DCS: Zookeeper <code>3.4.13</code></li> <li>Postgresql: <code>15.3</code></li></ul> <p>节点信息：</p> <table><thead><tr><th>节点名称</th> <th>IP地址</th> <th>端口</th> <th>角色（初始时）</th> <th>DC（datacenter）</th></tr></thead> <tbody><tr><td>node_172.16.245.4</td> <td>172.16.245.4</td> <td>5432</td> <td>Primary</td> <td>2</td></tr> <tr><td>node_172.16.245.5</td> <td>172.16.245.5</td> <td>5432</td> <td>Sync Standby</td> <td>2</td></tr> <tr><td>node_172.16.245.6</td> <td>172.16.245.6</td> <td>5432</td> <td>Primary</td> <td>3</td></tr></tbody></table> <h2 id="watchdog"><a href="#watchdog" class="header-anchor">#</a> watchdog</h2> <h3 id="_1-使用"><a href="#_1-使用" class="header-anchor">#</a> 1. 使用</h3> <p>安装软件狗 watchdog</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 安装</span>
yum <span class="token function">install</span> watchdog -y<span class="token punctuation">;</span>

<span class="token comment"># 加载软件狗</span>
modprobe softdog<span class="token punctuation">;</span>

<span class="token comment"># 设置开启自启</span>
systemctl <span class="token builtin class-name">enable</span> watchdog<span class="token punctuation">;</span>
</code></pre></div><h3 id="_2-问题"><a href="#_2-问题" class="header-anchor">#</a> 2. 问题</h3> <h4 id="_1-errno-2-no-such-file-or-directory-dev-watchdog"><a href="#_1-errno-2-no-such-file-or-directory-dev-watchdog" class="header-anchor">#</a> 1. [Errno 2] No such file or directory: '/dev/watchdog'</h4> <ul><li><p>Patroni 报错</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token number">2023</span>-07-30 <span class="token number">16</span>:36:02,915 WARNING: Could not activate Linux watchdog device: Can<span class="token string">'t open watchdog device: [Errno 2] No such file or directory: '</span>/dev/watchdog'
</code></pre></div></li> <li><p>解决方法：安装软件狗或者硬件狗</p></li></ul> <h4 id="_2-errno-13-permission-denied-dev-watchdog"><a href="#_2-errno-13-permission-denied-dev-watchdog" class="header-anchor">#</a> 2. [Errno 13] Permission denied: '/dev/watchdog'&quot;</h4> <ul><li><p>patroni 报错</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token number">2023</span>-07-30 <span class="token number">14</span>:30:10,087 WARNING: Could not activate Linux watchdog device: <span class="token string">&quot;Can't open watchdog device: [Errno 13] Permission denied: '/dev/watchdog'&quot;</span>
</code></pre></div></li> <li><p>解决方法：修改权限</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 查看</span>
<span class="token function">ls</span> <span class="token parameter variable">-l</span> /dev/watchdog
crw------- <span class="token number">1</span> root root <span class="token number">10</span>, <span class="token number">130</span> Feb <span class="token number">18</span> <span class="token number">13</span>:52 /dev/watchdog

<span class="token comment"># 修改权限</span>
<span class="token function">chmod</span> <span class="token number">666</span> /dev/watchdog

<span class="token comment"># 查看</span>
<span class="token function">ls</span> <span class="token parameter variable">-l</span> /dev/watchdog
crw-rw-rw- <span class="token number">1</span> root root <span class="token number">10</span>, <span class="token number">130</span> Feb <span class="token number">18</span> <span class="token number">13</span>:52 /dev/watchdog
</code></pre></div></li></ul> <h2 id="postgresql"><a href="#postgresql" class="header-anchor">#</a> PostgreSQL</h2> <h3 id="_1-同步复制槽的流程"><a href="#_1-同步复制槽的流程" class="header-anchor">#</a> 1. 同步复制槽的流程</h3> <p>根据传入的<code>dcs_failed</code>参数和集群状态，它决定是否需要操作复制槽。如果<code>dcs_failed</code>为True，表示与DCS的通信失败，此时如果当前节点是领导者或故障安全模式未启用，则不会处理复制槽。否则，根据集群的状态和配置来决定是否需要进行复制槽的同步操作。如果故障安全模式处于活动状态，则不进行复制槽的同步。最终，返回一个需要从主库复制的复制槽名称的列表。</p> <ul><li><p>读取复制槽的流程</p> <p>Patroni 首先会根据不同的 PG 主版本生成一些 SQL，有以下一些内容：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">if</span> self<span class="token punctuation">.</span>_postgresql<span class="token punctuation">.</span>major_version <span class="token operator">&gt;=</span> <span class="token number">90400</span> <span class="token keyword">and</span> self<span class="token punctuation">.</span>_schedule_load_slots<span class="token punctuation">:</span>
    replication_slots<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    extra <span class="token operator">=</span> <span class="token string">&quot;, catalog_xmin, pg_catalog.pg_wal_lsn_diff(confirmed_flush_lsn, '0/0')::bigint&quot;</span> \
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>_postgresql<span class="token punctuation">.</span>major_version <span class="token operator">&gt;=</span> <span class="token number">100000</span> <span class="token keyword">else</span> <span class="token string">&quot;&quot;</span>
    skip_temp_slots <span class="token operator">=</span> <span class="token string">' WHERE NOT temporary'</span> <span class="token keyword">if</span> self<span class="token punctuation">.</span>_postgresql<span class="token punctuation">.</span>major_version <span class="token operator">&gt;=</span> <span class="token number">100000</span> <span class="token keyword">else</span> <span class="token string">''</span>
</code></pre></div><p><code>pg_catalog.pg_wal_lsn_diff()</code> 这个函数用于计算两个 WAL LSN（Write-Ahead Log Logical Sequence Number）之间的差值。这个函数接受两个参数，都是 WAL LSN 的文本表示形式。它会计算第二个参数与第一个参数之间的差值，并返回一个 <code>bigint</code> 类型的结果，表示这两个 WAL LSN 之间的日志段数差距。</p> <p>接下来会查询复制槽，如果 PG 主版本匹配，则会附带上面展示的 SQL 进行查询：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">for</span> r <span class="token keyword">in</span> self<span class="token punctuation">.</span>_query<span class="token punctuation">(</span><span class="token string">'SELECT slot_name, slot_type, plugin, database, datoid'</span>
                     <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{</span>extra<span class="token punctuation">}</span></span><span class="token string"> FROM pg_catalog.pg_replication_slots</span><span class="token interpolation"><span class="token punctuation">{</span>skip_temp_slots<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    value <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'type'</span><span class="token punctuation">:</span> r<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
    <span class="token keyword">if</span> r<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'logical'</span><span class="token punctuation">:</span>
        value<span class="token punctuation">.</span>update<span class="token punctuation">(</span>plugin<span class="token operator">=</span>r<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> database<span class="token operator">=</span>r<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> datoid<span class="token operator">=</span>r<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>_postgresql<span class="token punctuation">.</span>major_version <span class="token operator">&gt;=</span> <span class="token number">100000</span><span class="token punctuation">:</span>
            value<span class="token punctuation">.</span>update<span class="token punctuation">(</span>catalog_xmin<span class="token operator">=</span>r<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> confirmed_flush_lsn<span class="token operator">=</span>r<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    replication_slots<span class="token punctuation">[</span>r<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> value
</code></pre></div></li></ul> <h2 id="config"><a href="#config" class="header-anchor">#</a> Config</h2> <h3 id="_1-使用-pyyaml-库对-yaml-的配置文件进行修改会导致配置项顺序混乱以及注释被清除"><a href="#_1-使用-pyyaml-库对-yaml-的配置文件进行修改会导致配置项顺序混乱以及注释被清除" class="header-anchor">#</a> 1. 使用  PyYAML 库对 <code>.yaml</code> 的配置文件进行修改会导致配置项顺序混乱以及注释被清除</h3> <p>在适配的过程中，检查配置项时，自动添加缺失的配置项时发现的这个问题，通过重写 PyYAML 库中的 <code>load</code> 和 <code>dump</code> 方法解决了修改数据导致的配置项顺序混乱的问题，但是似乎无法解决注释丢失的问题。通过网上的资料发现 <code>ruamel.yaml</code> 库可以更好的去处理 <code>yaml</code> 格式的配置文件，并且解决上述的问题，但是仅仅为了处理这个问题去替换 patroni 源码中的库或者添加一个新的库不太好，暂不使用这个方式。</p> <p>重写的 <code>load</code> 和 <code>dump</code> 方法如下：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># write or read file in the original order</span>
<span class="token keyword">def</span> <span class="token function">ordered_yaml_load</span><span class="token punctuation">(</span>stream<span class="token punctuation">,</span> Loader<span class="token operator">=</span>yaml<span class="token punctuation">.</span>SafeLoader<span class="token punctuation">,</span> object_pairs_hook<span class="token operator">=</span>OrderedDict<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">class</span> <span class="token class-name">OrderedLoader</span><span class="token punctuation">(</span>Loader<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span>

    <span class="token keyword">def</span> <span class="token function">_construct_mapping</span><span class="token punctuation">(</span>loader<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">:</span>
        loader<span class="token punctuation">.</span>flatten_mapping<span class="token punctuation">(</span>node<span class="token punctuation">)</span>
        <span class="token keyword">return</span> object_pairs_hook<span class="token punctuation">(</span>loader<span class="token punctuation">.</span>construct_pairs<span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span>

    OrderedLoader<span class="token punctuation">.</span>add_constructor<span class="token punctuation">(</span>
        yaml<span class="token punctuation">.</span>resolver<span class="token punctuation">.</span>BaseResolver<span class="token punctuation">.</span>DEFAULT_MAPPING_TAG<span class="token punctuation">,</span>
        _construct_mapping<span class="token punctuation">)</span>
    <span class="token keyword">return</span> yaml<span class="token punctuation">.</span>load<span class="token punctuation">(</span>stream<span class="token punctuation">,</span> OrderedLoader<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">ordered_yaml_dump</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> stream<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> Dumper<span class="token operator">=</span>yaml<span class="token punctuation">.</span>SafeDumper<span class="token punctuation">,</span> object_pairs_hook<span class="token operator">=</span>OrderedDict<span class="token punctuation">,</span> <span class="token operator">**</span>kwds<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">class</span> <span class="token class-name">OrderedDumper</span><span class="token punctuation">(</span>Dumper<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span>

    <span class="token keyword">def</span> <span class="token function">_dict_representer</span><span class="token punctuation">(</span>dumper<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> dumper<span class="token punctuation">.</span>represent_mapping<span class="token punctuation">(</span>
            yaml<span class="token punctuation">.</span>resolver<span class="token punctuation">.</span>BaseResolver<span class="token punctuation">.</span>DEFAULT_MAPPING_TAG<span class="token punctuation">,</span>
            data<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    OrderedDumper<span class="token punctuation">.</span>add_representer<span class="token punctuation">(</span>object_pairs_hook<span class="token punctuation">,</span> _dict_representer<span class="token punctuation">)</span>
    <span class="token keyword">return</span> yaml<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>data<span class="token punctuation">,</span> stream<span class="token punctuation">,</span> OrderedDumper<span class="token punctuation">,</span> <span class="token operator">**</span>kwds<span class="token punctuation">)</span>
</code></pre></div><blockquote><p>注意：未解决配置文件注释丢失的问题。</p></blockquote> <h2 id="dcs"><a href="#dcs" class="header-anchor">#</a> DCS</h2> <h3 id="_1-patroni-在-dcs-中写入了什么"><a href="#_1-patroni-在-dcs-中写入了什么" class="header-anchor">#</a> 1. Patroni 在 DCS 中写入了什么？</h3> <p>在集群初始化后，DCS 中会在 <code>/service/scope</code> （根据 Patroni 中配置的 <code>namespace</code> 和 <code>scope</code> 组合成的路径）路径下创建以下几个节点:</p> <blockquote><p><strong>注意：</strong></p> <ol><li>在启用 citus 或 mmr 的情况下， <code>/service/scope</code> 路径会多一层 <code>group</code> 路径。</li> <li><strong>本文档中测试环境使用的 DCS 技术是 Zookeeper，其中存储的数据格式为 JSON</strong>，不同的 DCS 技术可能存储的数据格式会不一样，但是存储的内容是一致的。</li></ol></blockquote> <ul><li><p><code>leader</code> : 用于标识当前的领导者节点。这个键的值是领导者节点的名称。在领导者选举过程中，各个候选节点会竞争写入这个键，最终写入成功的节点将成为领导者。</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">7</span><span class="token punctuation">]</span> get /service/test/2/leader
node_172_16_245_4
</code></pre></div></li> <li><p><code>failover</code> : 记录了故障切换的相关信息，如切换的目标节点、切换开始时间等。在进行手动或自动故障切换时，会写入这个键。</p></li> <li><p><code>members</code> : 记录了集群中各个成员节点的状态、角色、连接信息等。包括节点名称、连接URL、角色（主库、从库）、状态等信息。</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># members 中包含着集群中的节点信息</span>
<span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token function">ls</span> /service/test/2/members
<span class="token punctuation">[</span>node_172_16_245_4, node_172_16_245_5<span class="token punctuation">]</span>

<span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">2</span><span class="token punctuation">]</span> get /service/test/2/members/node_172_16_245_4
<span class="token punctuation">{</span><span class="token string">&quot;conn_url&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;postgres://172.16.245.4:5432/postgres&quot;</span>,<span class="token string">&quot;api_url&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;http://172.16.245.4:8008/patroni&quot;</span>,<span class="token string">&quot;state&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;running&quot;</span>,<span class="token string">&quot;role&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;master&quot;</span>,<span class="token string">&quot;version&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;3.0.2&quot;</span>,<span class="token string">&quot;pending_restart&quot;</span>:true,<span class="token string">&quot;xlog_location&quot;</span>:50455880,<span class="token string">&quot;timeline&quot;</span>:3<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><code>initialize</code> : 记录集群初始化的状态。其中存储着数据库的 <code>sysid</code> 信息。这个信息对应 <code>pg_controldata</code> 命令中输出的 <code>Database system identifier</code> 。</p> <div class="language- extra-class"><pre class="language-text"><code>[zk: localhost:2181(CONNECTED) 0] get /service/test/2/initialize
7265080646965906116
</code></pre></div></li> <li><p><code>history</code> : 记录了过去发生的故障切换操作的相关信息，如切换的时间、目标节点、切换类型等。</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">4</span><span class="token punctuation">]</span> get /service/test/2/history
<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1,50332376</span>,<span class="token string">&quot;no recovery target specified&quot;</span>,<span class="token string">&quot;2023-08-03T20:35:14.405331-04:00&quot;</span>,<span class="token string">&quot;node_172_16_245_5&quot;</span><span class="token punctuation">]</span>,<span class="token punctuation">[</span><span class="token number">2,50400256</span>,<span class="token string">&quot;no recovery target specified&quot;</span>,<span class="token string">&quot;2023-08-08T19:42:14.979349-04:00&quot;</span>,<span class="token string">&quot;node_172_16_245_4&quot;</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
</code></pre></div></li> <li><p><code>config</code> : 记录了 PostgreSQL 数据库的配置参数，用于在集群中的各个节点之间共享配置信息。</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">9</span><span class="token punctuation">]</span> get /service/test/2/config  
<span class="token punctuation">{</span><span class="token string">&quot;ttl&quot;</span>:30,<span class="token string">&quot;loop_wait&quot;</span>:10,<span class="token string">&quot;retry_timeout&quot;</span>:10,<span class="token string">&quot;maximum_lag_on_failover&quot;</span>:1048576,<span class="token string">&quot;postgresql&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;use_pg_rewind&quot;</span>:true,<span class="token string">&quot;parameters&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;listen_addresses&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;*&quot;</span>,<span class="token string">&quot;port&quot;</span>:5432,<span class="token string">&quot;max_connections&quot;</span>:100,<span class="token string">&quot;shared_buffers&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;128MB&quot;</span>,<span class="token string">&quot;logical_decoding_work_mem&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;64MB&quot;</span>,<span class="token string">&quot;dynamic_shared_memory_type&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;posix&quot;</span>,<span class="token string">&quot;wal_level&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;logical&quot;</span>,<span class="token string">&quot;max_wal_size&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;1GB&quot;</span>,<span class="token string">&quot;min_wal_size&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;80MB&quot;</span>,<span class="token string">&quot;max_wal_senders&quot;</span>:10,<span class="token string">&quot;max_replication_slots&quot;</span>:10,<span class="token string">&quot;track_commit_timestamp&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;on&quot;</span>,<span class="token string">&quot;max_sync_workers_per_subscription&quot;</span>:4,<span class="token string">&quot;logging_collector&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;on&quot;</span>,<span class="token string">&quot;log_directory&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;log&quot;</span>,<span class="token string">&quot;log_filename&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;postgresql-%a.log&quot;</span>,<span class="token string">&quot;log_rotation_age&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;1d&quot;</span>,<span class="token string">&quot;log_rotation_size&quot;</span>:0,<span class="token string">&quot;log_truncate_on_rotation&quot;</span>:true,<span class="token string">&quot;log_min_messages&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;debug1&quot;</span>,<span class="token string">&quot;log_min_error_statement&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;debug1&quot;</span>,<span class="token string">&quot;log_timezone&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;Asia/Shanghai&quot;</span>,<span class="token string">&quot;datestyle&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;iso, mdy&quot;</span>,<span class="token string">&quot;timezone&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;Asia/Shanghai&quot;</span>,<span class="token string">&quot;lc_messages&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;C&quot;</span>,<span class="token string">&quot;lc_monetary&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;C&quot;</span>,<span class="token string">&quot;lc_numeric&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;C&quot;</span>,<span class="token string">&quot;lc_time&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;C&quot;</span>,<span class="token string">&quot;default_text_search_config&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;pg_catalog.english&quot;</span>,<span class="token string">&quot;shared_preload_libraries&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;fdd_mmr&quot;</span>,<span class="token string">&quot;fdd.running_databases&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;postgres, test_mmr, test_for_mmr&quot;</span>,<span class="token string">&quot;fdd.search_dead_tup_time_interval&quot;</span>:5000<span class="token punctuation">}</span><span class="token punctuation">}</span>,<span class="token string">&quot;synchronous_mode&quot;</span>:true<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><code>sync</code> : 记录了同步模式下的相关信息，如同步节点列表、同步状态等。在同步模式下，各个节点会定期写入和更新这个键。</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">4</span><span class="token punctuation">]</span> get /service/test/2/sync
<span class="token punctuation">{</span><span class="token string">&quot;leader&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;node_172_16_245_4&quot;</span>,<span class="token string">&quot;sync_standby&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;node_172_16_245_5&quot;</span><span class="token punctuation">}</span>
</code></pre></div></li> <li><p><code>status</code> : 记录了当前 leader 节点的 last_lsn（Optime）。用于在切换过程中确保数据一致性。</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">6</span><span class="token punctuation">]</span> get /service/test/2/status
<span class="token punctuation">{</span><span class="token string">&quot;optime&quot;</span>:50456216<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h3 id="_2-dcs-modules-method"><a href="#_2-dcs-modules-method" class="header-anchor">#</a> 2. dcs_modules [method]</h3> <p>在 dcs 的 <code>__init__.py</code> 中获取已经实现的 dcs 接口类方法中存在这么一个判断：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">if</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>sys<span class="token punctuation">,</span> <span class="token string">'frozen'</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    toc<span class="token punctuation">:</span> Set<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># dcs_dirname may contain a dot, which causes pkgutil.iter_importers()</span>
    <span class="token comment"># to misinterpret the path as a package name. This can be avoided</span>
    <span class="token comment"># altogether by not passing a path at all, because PyInstaller's</span>
    <span class="token comment"># FrozenImporter is a singleton and registered as top-level finder.</span>
    <span class="token keyword">for</span> importer <span class="token keyword">in</span> pkgutil<span class="token punctuation">.</span>iter_importers<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>importer<span class="token punctuation">,</span> <span class="token string">'toc'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            toc <span class="token operator">|</span><span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>importer<span class="token punctuation">,</span> <span class="token string">'toc'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>module <span class="token keyword">for</span> module <span class="token keyword">in</span> toc <span class="token keyword">if</span> module<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span>module_prefix<span class="token punctuation">)</span> <span class="token keyword">and</span> module<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">]</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>module_prefix <span class="token operator">+</span> name <span class="token keyword">for</span> _<span class="token punctuation">,</span> name<span class="token punctuation">,</span> is_pkg <span class="token keyword">in</span> pkgutil<span class="token punctuation">.</span>iter_modules<span class="token punctuation">(</span><span class="token punctuation">[</span>dcs_dirname<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token keyword">not</span> is_pkg<span class="token punctuation">]</span>

</code></pre></div><p>参考 Pyinstaller 手册中描述：</p> <blockquote><p>您的应用程序应该在捆绑包中与从源代码运行时的表现完全一致。然而，您可能希望在运行时了解应用程序是从源代码运行还是已捆绑（&quot;冻结&quot;）。您可以使用以下代码来检查“是否已捆绑”：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> sys
<span class="token keyword">if</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>sys<span class="token punctuation">,</span> <span class="token string">'frozen'</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>sys<span class="token punctuation">,</span> <span class="token string">'_MEIPASS'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'running in a PyInstaller bundle'</span><span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'running in a normal Python process'</span><span class="token punctuation">)</span>
</code></pre></div><p>当捆绑的应用程序启动时，引导加载程序会设置<code>sys.frozen</code> 属性，并将捆绑文件夹的绝对路径存储在 <code>sys._MEIPASS</code> 中。对于一个单文件夹捆绑包，这是指向该文件夹的路径。对于一个单文件捆绑包，这是引导加载程序创建的临时文件夹的路径（请参阅单文件程序的工作原理）。</p> <p>在应用程序运行时，它可能需要访问以下位置之一的数据文件：</p> <ul><li><p>与其捆绑在一起的文件（请参阅添加数据文件）。</p></li> <li><p>用户放置在应用程序捆绑包中的文件，例如位于同一文件夹中的文件。</p></li> <li><p>用户当前工作目录中的文件。</p></li></ul> <p>程序可以访问几个变量来满足这些用途。</p></blockquote> <p>因此，这段代码在开发环境下执行会从源码中去加载已经实现的 dcs 接口类，在打包后会从捆绑的包中加载对于的源码。这样写的好处是避免 <code>dcs_dirname</code> 因为包含一个点，导致 <code>pkgutil.iter_importers()</code> 错误地将路径解释为包名的问题。</p> <blockquote><p><strong><code>FrozenImporter</code> 是什么 ?</strong></p> <p><code>FrozenImporter</code> 是 Python 的导入机制中的一个概念，它在冻结（或打包）的应用程序中起着重要作用。在解释 <code>FrozenImporter</code> 之前，让我们先了解一下 Python 的导入机制。</p> <p>Python 中的导入机制允许你在代码中引用其他模块或脚本，以便重用代码和模块化开发。当你在代码中使用 <code>import</code> 语句来导入一个模块时，Python 解释器会按照一定的规则在不同的路径中查找这个模块，然后加载它并使其可用。</p> <p><code>FrozenImporter</code> 是 Python 导入机制的一个特殊实现，用于处理被“冻结”或“打包”成单个可执行文件的应用程序。当你使用工具如 PyInstaller、cx_Freeze 等将 Python 应用程序打包成单个可执行文件时，这些工具会将应用程序中所需的模块和资源一起打包，以便在不需要原始源代码的情况下运行应用程序。</p> <p><code>FrozenImporter</code> 的主要功能是从打包的资源中加载模块。它会在运行时根据应用程序的文件结构和打包的内容来定位并加载模块，而无需实际的文件路径。这使得打包的应用程序能够以与原始源代码相同的方式使用导入语句，而无需担心实际文件路径。</p> <p>总之，<code>FrozenImporter</code> 是 Python 导入机制在冻结或打包应用程序中的一种特殊实现，它允许打包的应用程序像正常导入模块一样使用导入语句，从而实现了模块化和资源管理。在前面提到的代码段中，使用 <code>FrozenImporter</code> 可以避免路径中包含点时 <code>pkgutil.iter_importers()</code> 的错误解释问题。</p></blockquote> <h3 id="_3-leader-class"><a href="#_3-leader-class" class="header-anchor">#</a> 3. Leader [class]</h3> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">Leader</span><span class="token punctuation">(</span>NamedTuple<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;Immutable object (namedtuple) which represents leader key.

    Consists of the following fields:
    :param version: modification version of a leader key in a Configuration Store
    :param session: either session id or just ttl in seconds
    :param member: reference to a `Member` object which represents current leader (see `Cluster.members`)
    &quot;&quot;&quot;</span>
    version<span class="token punctuation">:</span> _Version
    session<span class="token punctuation">:</span> _Session
    member<span class="token punctuation">:</span> Member
</code></pre></div><p>在 Zookeeper 实现类中，Leader 类对象的创建流程：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># 这部分代码位于 zookeeper 的 _cluster_loader 方法中</span>
leader <span class="token operator">=</span> self<span class="token punctuation">.</span>get_node<span class="token punctuation">(</span>path <span class="token operator">+</span> self<span class="token punctuation">.</span>_LEADER<span class="token punctuation">)</span> <span class="token keyword">if</span> self<span class="token punctuation">.</span>_LEADER <span class="token keyword">in</span> nodes <span class="token keyword">else</span> <span class="token boolean">None</span>
        <span class="token keyword">if</span> leader<span class="token punctuation">:</span>
            member <span class="token operator">=</span> Member<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> leader<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            member <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>m <span class="token keyword">for</span> m <span class="token keyword">in</span> members <span class="token keyword">if</span> m<span class="token punctuation">.</span>name <span class="token operator">==</span> leader<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token keyword">or</span> <span class="token punctuation">[</span>member<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            leader <span class="token operator">=</span> Leader<span class="token punctuation">(</span>leader<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>version<span class="token punctuation">,</span> leader<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ephemeralOwner<span class="token punctuation">,</span> member<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>_fetch_cluster <span class="token operator">=</span> member<span class="token punctuation">.</span>version <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span>
</code></pre></div><p><code>leader</code> 在 Zookeeper 中存储的内容如下：</p> <div class="language-ini extra-class"><pre class="language-ini"><code><span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">zk: localhost:2181(CONNECTED) 3</span><span class="token punctuation">]</span></span> get /service/test/2/leader
node_172_16_245_4
<span class="token key attr-name">cZxid</span> <span class="token punctuation">=</span> <span class="token value attr-value">0x1f0000000f</span>
<span class="token key attr-name">ctime</span> <span class="token punctuation">=</span> <span class="token value attr-value">Tue Aug 01 22:55:56 EDT 2023</span>
<span class="token key attr-name">mZxid</span> <span class="token punctuation">=</span> <span class="token value attr-value">0x1f0000000f</span>
<span class="token key attr-name">mtime</span> <span class="token punctuation">=</span> <span class="token value attr-value">Tue Aug 01 22:55:56 EDT 2023</span>
<span class="token key attr-name">pZxid</span> <span class="token punctuation">=</span> <span class="token value attr-value">0x1f0000000f</span>
<span class="token key attr-name">cversion</span> <span class="token punctuation">=</span> <span class="token value attr-value">0</span>
<span class="token key attr-name">dataVersion</span> <span class="token punctuation">=</span> <span class="token value attr-value">0</span>
<span class="token key attr-name">aclVersion</span> <span class="token punctuation">=</span> <span class="token value attr-value">0</span>
<span class="token key attr-name">ephemeralOwner</span> <span class="token punctuation">=</span> <span class="token value attr-value">0x20009a1dafc0000</span>
<span class="token key attr-name">dataLength</span> <span class="token punctuation">=</span> <span class="token value attr-value">17</span>
<span class="token key attr-name">numChildren</span> <span class="token punctuation">=</span> <span class="token value attr-value">0</span>
</code></pre></div><p><strong>其中 <code>node_172_16_245_4</code> 为该节点存储的数据，下面的是节点状态信息，具体解释如下：</strong></p> <ul><li><code>cZxid</code> : 创建事务的 ID（Zxid），表示节点的创建操作的事务 ID。</li> <li><code>ctime</code> : 创建时间，表示节点的创建时间。</li> <li><code>mZxid</code> : 最近修改事务的 ID（Zxid），表示节点的最后修改操作的事务 ID。</li> <li><code>mtime</code> : 最近修改时间，表示节点的最后修改时间。</li> <li><code>pZxid</code>: 最近修改子节点事务的 ID（Zxid），表示子节点的最后修改操作的事务 ID。</li> <li><code>cversion</code> : 子节点修改次数，表示子节点的版本号。</li> <li><code>dataVersion</code> : 数据版本，表示节点数据的版本号。</li> <li><code>aclVersion</code> : ACL 版本，表示节点的访问控制列表（ACL）的版本号。</li> <li><code>ephemeralOwner</code> : 临时节点所有者，如果节点是临时节点，则表示拥有该临时节点的会话 ID。</li> <li><code>dataLength</code> : 数据长度，表示节点存储的数据的长度。</li> <li><code>numChildren</code> : 子节点数量，表示节点的子节点数量。</li></ul> <p><strong>而 kazoo 库中 <code>get()</code> 方法返回的内容中包含的 <code>ZnodeStat</code> 信息如下：</strong></p> <ul><li><p><code>creation_transaction_id(*czxid*)</code> :</p> <p>导致此znode创建的更改的事务ID。</p></li> <li><p><code>last_modified_transaction_id(*mzxid*)</code> ：</p> <p>最后修改此znode的更改的事务ID。</p></li> <li><p><code>created(*ctime*)</code> ：</p> <p>此znode创建的时间，从纪元开始的秒数。（ctime以毫秒为单位）</p></li> <li><p><code>last_modified(*mtime*)</code> ：</p> <p>此znode最后修改的时间，从纪元开始的秒数。（mtime以毫秒为单位）</p></li> <li><p><code>version</code> ：</p> <p>此znode的数据更改次数。</p></li> <li><p><code>acl_version(*aversion*)</code> ：</p> <p>此znode的ACL更改次数。</p></li> <li><p><code>owner_session_id(*ephemeralOwner*)</code> ：</p> <p>如果znode是临时节点，则为此znode的所有者的会话ID。如果它不是临时节点，则为None。（如果不是临时节点，ephemeralOwner将为0）</p></li> <li><p><code>data_length(*dataLength*)</code>：</p> <p>此znode的数据字段长度。</p></li> <li><p><code>children_count(*numChildren*)</code> ：</p> <p>此znode的子节点数量。</p></li></ul> <p><strong>然后我们就可以解释一下这三个参数：</strong></p> <ul><li><code>version</code> : 在创建是传入的是 <code>leader[1].version</code> 获取的正是 zookeeper 中存储的节点状态信息中的 <code>cVersion</code>。</li> <li><code>session</code> : zookeeper 中存储的节点状态信息中的 <code>ephemeralOwner</code> 参数。</li> <li><code>member</code> : 为 zookeeper 中存储的 <code>/memeber</code> 路径下对应的 <code>leader</code> 节点的信息。</li></ul> <h2 id="ha"><a href="#ha" class="header-anchor">#</a> HA</h2> <h3 id="_1-post-bootstrap-method"><a href="#_1-post-bootstrap-method" class="header-anchor">#</a> 1. post_bootstrap[method]</h3> <img src="http://img.sweetbabywow.club/patctl/HA%20post_bootstrap" style="zoom:39%;"> <center></center>post_bootstrap 流程图
<p>这段代码是一个方法，名为 <code>post_bootstrap</code>，用于在数据库集群引导启动（bootstrap）后进行一系列后续操作。让我逐步解释其主要步骤和逻辑：</p> <ol><li>首先，代码使用 <code>with self._async_response</code> 进入一个异步块，从 <code>_async_response</code> 获取异步操作的结果，存储在变量 <code>result</code> 中。</li> <li>接下来，代码检查以下情况：
<ul><li>如果 PostgreSQL 数据库未运行（<code>state_handler.is_running()</code> 返回 <code>False</code>）或者 <code>result</code> 为 <code>False</code>，则调用 <code>cancel_initialization</code> 方法取消引导初始化，表示引导启动失败。</li> <li>如果 <code>result</code> 为 <code>None</code>，继续执行后续操作。</li></ul></li> <li>如果当前节点不是主节点，方法返回字符串 <code>'waiting for end of recovery after bootstrap'</code>，表示当前节点正在等待引导启动过程完成。</li> <li>如果当前节点是主节点，代码通过 <code>state_handler.set_role('master')</code> 将当前节点设置为主节点。</li> <li>然后，代码使用 <code>_async_executor.try_run_async</code> 异步执行名为 <code>post_bootstrap</code> 的操作，该操作在 <code>self.state_handler.bootstrap.post_bootstrap</code> 中定义，传递一些参数。操作的结果存储在变量 <code>ret</code> 中。</li> <li>如果 <code>result</code> 不为空，说明引导启动成功，继续执行以下操作：
<ul><li>将 <code>bootstrapping</code> 属性设置为 <code>False</code>，表示引导启动完成。</li> <li>激活看门狗（watchdog）以确保故障检测功能正常运行。如果激活失败，记录错误日志并调用 <code>cancel_initialization</code> 取消初始化。</li> <li>使用 <code>_rewind.ensure_checkpoint_after_promote</code> 方法确保在升级为主节点后进行检查点。</li> <li>初始化分布式一致性服务（DCS）：根据情况创建新的集群（如果 <code>cluster.initialize</code> 为空），并将系统标识（sysid）传递给 DCS。</li> <li>将动态配置信息序列化并存储到 DCS 配置中。</li> <li>将当前节点设置为主节点。</li> <li>调用 <code>CallbackAction.ON_START</code> 来执行节点启动回调操作。</li> <li>从 DCS 中加载集群信息。</li></ul></li> <li>最后，方法返回字符串 <code>'initialized a new cluster'</code>，表示集群已成功完成初始化。</li></ol> <p>总之，这个方法在数据库集群引导启动完成后，根据节点的角色和引导启动结果，执行一系列后续操作，包括设置节点角色、激活看门狗、创建检查点、初始化分布式一致性服务等。</p> <h3 id="_2-bootstrap-method"><a href="#_2-bootstrap-method" class="header-anchor">#</a> 2. bootstrap [method]</h3> <p><img src="http://img.sweetbabywow.club/patroni_for_mmr/HA%20bootstrap" alt=""></p> <center></center>bootstrap 流程图
<p>这段代码主要定义了一个名为 <code>bootstrap</code> 的方法，该方法用于在集群引导过程中执行一系列操作。以下是对代码中每个部分的简要解释：</p> <ol><li><p><strong>检查是否允许 bootstrap</strong>：首先，代码检查是否满足 bootstrap 的条件。要求集群没有被锁定（is_unlocked()）、没有初始化密钥（initialize is None）、不禁用故障切换（nofailover 为 False）以及配置文件中存在 &quot;bootstrap&quot; 部分。如果满足这些条件，就可以尝试引导。</p></li> <li><p><strong>尝试引导</strong>：在满足引导条件时，代码会尝试执行 bootstrap 操作。它会先尝试获取初始化锁（initialize lock），如果成功获得锁，则进入引导状态。根据集群的不同情况，可能会调用不同的方法来执行引导操作。</p></li> <li><p><strong>检查是否有克隆成员</strong>：如果集群已经有了一个领导节点（leader），则可以从领导节点或其中一个从节点（replica）bootstrap。在这种情况下，代码会查找适合 bootstrap 的成员，并调用 <code>clone</code> 方法来执行引导操作。</p></li> <li><p><strong>检查是否允许无领导节点 bootstrap</strong>：如果集群没有领导节点，但配置允许通过备份工具创建从节点，则可以尝试无领导节点 bootstrap。代码会检查是否满足这个条件，并在不允许并发 bootstrap 的情况下执行 bootstrap 操作。</p></li> <li><p><strong>返回 bootstrap 状态</strong>：在以上情况都不满足时，代码会返回等待 bootstrap 的状态。根据是否是从节点集群，会返回不同的等待信息。</p></li></ol> <h2 id="switchover-failover"><a href="#switchover-failover" class="header-anchor">#</a> Switchover &amp; Failover</h2> <h3 id="主备切换-switchover"><a href="#主备切换-switchover" class="header-anchor">#</a> 主备切换（Switchover）</h3> <p><img src="http://img.sweetbabywow.club/patctl/patroni%20%E6%89%8B%E5%8A%A8%E6%95%85%E9%9A%9C%E8%BD%AC%E7%A7%BB" alt=""></p> <center></center>主备切换流程图
<h3 id="故障转移-failover"><a href="#故障转移-failover" class="header-anchor">#</a> 故障转移（Failover）</h3></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/ha/数据库高可用部署.html" class="prev">
        数据库高可用部署
      </a></span> <span class="next"><a href="/write_log/随笔.html">
        随笔
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.4e56e56e.js" defer></script><script src="/assets/js/2.3dc1b8de.js" defer></script><script src="/assets/js/1.7f771cfb.js" defer></script><script src="/assets/js/23.79c4ee49.js" defer></script>
  </body>
</html>
