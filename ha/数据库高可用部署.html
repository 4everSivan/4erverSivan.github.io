<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>数据库高可用部署 | Sivan Page</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/assets/css/0.styles.8f3dca9f.css" as="style"><link rel="preload" href="/assets/js/app.4e56e56e.js" as="script"><link rel="preload" href="/assets/js/2.3dc1b8de.js" as="script"><link rel="preload" href="/assets/js/1.7f771cfb.js" as="script"><link rel="preload" href="/assets/js/24.f176594d.js" as="script"><link rel="prefetch" href="/assets/js/10.23a1f579.js"><link rel="prefetch" href="/assets/js/11.c389195a.js"><link rel="prefetch" href="/assets/js/12.1d996921.js"><link rel="prefetch" href="/assets/js/13.4d4410c4.js"><link rel="prefetch" href="/assets/js/14.37ef2a72.js"><link rel="prefetch" href="/assets/js/15.5542c093.js"><link rel="prefetch" href="/assets/js/16.d48fd1ce.js"><link rel="prefetch" href="/assets/js/17.bd8d538c.js"><link rel="prefetch" href="/assets/js/18.6d3b94c1.js"><link rel="prefetch" href="/assets/js/19.eb35cfee.js"><link rel="prefetch" href="/assets/js/20.c11ec329.js"><link rel="prefetch" href="/assets/js/21.db1b5d88.js"><link rel="prefetch" href="/assets/js/22.6916f4ef.js"><link rel="prefetch" href="/assets/js/23.79c4ee49.js"><link rel="prefetch" href="/assets/js/25.00acdf15.js"><link rel="prefetch" href="/assets/js/26.9b34ee88.js"><link rel="prefetch" href="/assets/js/27.2a70b75b.js"><link rel="prefetch" href="/assets/js/28.d18ecdb6.js"><link rel="prefetch" href="/assets/js/29.91511347.js"><link rel="prefetch" href="/assets/js/3.5322f14a.js"><link rel="prefetch" href="/assets/js/30.1fba689d.js"><link rel="prefetch" href="/assets/js/4.84e1e480.js"><link rel="prefetch" href="/assets/js/5.f0541060.js"><link rel="prefetch" href="/assets/js/6.dfb06aa0.js"><link rel="prefetch" href="/assets/js/7.7551a9fb.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.5e19b665.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8f3dca9f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Sivan Page</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程语言" class="dropdown-title"><span class="title">编程</span> <span class="arrow down"></span></button> <button type="button" aria-label="编程语言" class="mobile-dropdown-title"><span class="title">编程</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/python/Python3.10安装.html" class="nav-link">
  Python
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/mysql/MySQL简介.html" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/sql_server/" class="nav-link">
  SQL Server
</a></li><li class="dropdown-item"><!----> <a href="/pg/PostgreSQL简介.html" class="nav-link">
  PostgreSQL
</a></li><li class="dropdown-item"><!----> <a href="/ha/数据库高可用部署.html" class="nav-link">
  HA
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="运维" class="dropdown-title"><span class="title">运维</span> <span class="arrow down"></span></button> <button type="button" aria-label="运维" class="mobile-dropdown-title"><span class="title">运维</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/linux/Linux简介.html" class="nav-link">
  Linux
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="文章" class="dropdown-title"><span class="title">文章</span> <span class="arrow down"></span></button> <button type="button" aria-label="文章" class="mobile-dropdown-title"><span class="title">文章</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/translation/" class="nav-link">
  翻译
</a></li><li class="dropdown-item"><!----> <a href="/day_log/" class="nav-link">
  杂记
</a></li><li class="dropdown-item"><!----> <a href="/write_log/随笔.html" class="nav-link">
  随笔
</a></li></ul></div></div><div class="nav-item"><a href="/me/" class="nav-link">
  关于我
</a></div><div class="nav-item"><a href="https://github.com/4everSivan" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程语言" class="dropdown-title"><span class="title">编程</span> <span class="arrow down"></span></button> <button type="button" aria-label="编程语言" class="mobile-dropdown-title"><span class="title">编程</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/python/Python3.10安装.html" class="nav-link">
  Python
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/mysql/MySQL简介.html" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/sql_server/" class="nav-link">
  SQL Server
</a></li><li class="dropdown-item"><!----> <a href="/pg/PostgreSQL简介.html" class="nav-link">
  PostgreSQL
</a></li><li class="dropdown-item"><!----> <a href="/ha/数据库高可用部署.html" class="nav-link">
  HA
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="运维" class="dropdown-title"><span class="title">运维</span> <span class="arrow down"></span></button> <button type="button" aria-label="运维" class="mobile-dropdown-title"><span class="title">运维</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/linux/Linux简介.html" class="nav-link">
  Linux
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="文章" class="dropdown-title"><span class="title">文章</span> <span class="arrow down"></span></button> <button type="button" aria-label="文章" class="mobile-dropdown-title"><span class="title">文章</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/translation/" class="nav-link">
  翻译
</a></li><li class="dropdown-item"><!----> <a href="/day_log/" class="nav-link">
  杂记
</a></li><li class="dropdown-item"><!----> <a href="/write_log/随笔.html" class="nav-link">
  随笔
</a></li></ul></div></div><div class="nav-item"><a href="/me/" class="nav-link">
  关于我
</a></div><div class="nav-item"><a href="https://github.com/4everSivan" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/python/Python3.10安装" class="sidebar-heading clickable"><span>Python</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/linux/Linux简介" class="sidebar-heading clickable"><span>Linux</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/pg/PostgreSQL简介" class="sidebar-heading clickable"><span>PostgreSQL</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/mysql/MySQL简介" class="sidebar-heading clickable"><span>MySQL</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/ha/数据库高可用部署" class="sidebar-heading clickable open active"><span>HA</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/ha/数据库高可用部署.html" class="active sidebar-link">数据库高可用部署</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/ha/数据库高可用部署.html#_1-虚拟机相关信息" class="sidebar-link">1. 虚拟机相关信息</a></li><li class="sidebar-sub-header"><a href="/ha/数据库高可用部署.html#_2-版本信息" class="sidebar-link">2. 版本信息</a></li><li class="sidebar-sub-header"><a href="/ha/数据库高可用部署.html#_3-搭建主从数据库" class="sidebar-link">3. 搭建主从数据库</a></li><li class="sidebar-sub-header"><a href="/ha/数据库高可用部署.html#_4-安装pgbouncer" class="sidebar-link">4. 安装pgbouncer</a></li><li class="sidebar-sub-header"><a href="/ha/数据库高可用部署.html#_5-安装zookeeper" class="sidebar-link">5. 安装Zookeeper</a></li><li class="sidebar-sub-header"><a href="/ha/数据库高可用部署.html#_6-安装patroni" class="sidebar-link">6. 安装Patroni</a></li></ul></li><li><a href="/ha/Patroni总结.html" class="sidebar-link">Patroni</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/write_log/随笔" class="sidebar-heading clickable"><span>随笔</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="数据库高可用部署"><a href="#数据库高可用部署" class="header-anchor">#</a> 数据库高可用部署</h1> <p>[TOC]</p> <hr> <h2 id="_1-虚拟机相关信息"><a href="#_1-虚拟机相关信息" class="header-anchor">#</a> 1. 虚拟机相关信息</h2> <table><thead><tr><th>主机</th> <th>地址</th> <th>服务</th> <th>zookeeper角色</th></tr></thead> <tbody><tr><td>b1</td> <td>192.168.121.190</td> <td>postgresql + zookeeper</td> <td>follower</td></tr> <tr><td>b2</td> <td>192.168.121.187</td> <td>postgresql + zookeeper + pgbouncer + patroni （主库）</td> <td>leader</td></tr> <tr><td>b3</td> <td>192.168.121.189</td> <td>postgresql + zookeeper + pgbouncer + patroni （备库）</td> <td>follower</td></tr></tbody></table> <h2 id="_2-版本信息"><a href="#_2-版本信息" class="header-anchor">#</a> 2. 版本信息</h2> <table><thead><tr><th>包名</th> <th>版本</th></tr></thead> <tbody><tr><td>CentOS</td> <td>7.9</td></tr> <tr><td>PostgreSQL</td> <td>10.5</td></tr> <tr><td>Pgbouncer</td> <td>1.8.1</td></tr> <tr><td>Zookeeper</td> <td>3.4.13</td></tr> <tr><td>Patroni</td> <td>1.4.4</td></tr></tbody></table> <blockquote><p><strong>注意</strong>：本部署方案已经完成了内核配置和数据库安装流程</p></blockquote> <h2 id="_3-搭建主从数据库"><a href="#_3-搭建主从数据库" class="header-anchor">#</a> 3. 搭建主从数据库</h2> <blockquote><p>在主库虚拟机上进行如下配置</p></blockquote> <h3 id="_3-1-huge-pages配置"><a href="#_3-1-huge-pages配置" class="header-anchor">#</a> 3.1 huge pages配置</h3> <ol><li>执行脚本 <code>calc-hugePages.sh</code>计算当前机器设置的页面数，脚本内容如下：</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code> <span class="token comment">#!/bin/bash</span>
<span class="token assign-left variable">pid</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">head</span> <span class="token parameter variable">-1</span> $PGDATA/postmaster.pid<span class="token variable">`</span></span>
<span class="token builtin class-name">echo</span> <span class="token string">&quot;Pid:            <span class="token variable">$pid</span>&quot;</span>
<span class="token assign-left variable">peak</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">grep</span> ^VmPeak /proc/$pid/status <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{ print $2 }'</span><span class="token variable">`</span></span>
<span class="token builtin class-name">echo</span> <span class="token string">&quot;VmPeak:            <span class="token variable">$peak</span> kB&quot;</span>
<span class="token assign-left variable">hps</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">grep</span> ^Hugepagesize /proc/meminfo <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{ print $2 }'</span><span class="token variable">`</span></span>
<span class="token builtin class-name">echo</span> <span class="token string">&quot;Hugepagesize:   <span class="token variable">$hps</span> kB&quot;</span>
<span class="token assign-left variable">hp</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>peak<span class="token operator">/</span>hps<span class="token variable">))</span></span>
<span class="token builtin class-name">echo</span> Set Huge Pages:     <span class="token variable">$hp</span>
</code></pre></div><ol start="2"><li>将执行计算出的页面数设置到sysctl.conf中</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token builtin class-name">echo</span> <span class="token string">&quot;vm.nr_hugepages = 147&quot;</span><span class="token operator">&gt;&gt;</span>/etc/sysctl.conf
</code></pre></div><ol start="3"><li>查看是否设置成功</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">sysctl</span> <span class="token parameter variable">-p</span>
</code></pre></div><ol start="4"><li>修改数据库设置，开启对大页面的支持</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">vim</span> <span class="token variable">$PGDATA</span>/postgresql.conf
	huge_pages <span class="token operator">=</span> on
</code></pre></div><ol start="5"><li>重启数据库</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>pg_ctl restart
</code></pre></div><h3 id="_3-2-配置流复制"><a href="#_3-2-配置流复制" class="header-anchor">#</a> 3.2 配置流复制</h3> <blockquote><p>主库配置</p></blockquote> <ol><li>配置允许访问的ip</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code> <span class="token number">1</span>. 切换目录
 	<span class="token builtin class-name">cd</span> <span class="token variable">$PGDATA</span>
 
 <span class="token number">2</span>.备份pg_hba.conf文件
 	<span class="token function">cp</span> pg_hba.conf<span class="token punctuation">{</span>,.bak<span class="token punctuation">}</span>
 
 <span class="token number">3</span>. 修改pg_hba.conf，修改pg_hba.conf参数，如主从复制的主库加入用户replicate、从库的ip<span class="token punctuation">(</span><span class="token number">192.168</span>.6.22/24<span class="token punctuation">)</span>
 	<span class="token function">vim</span> pg_hba.conf
	 <span class="token comment"># 添加如下配置</span>
 	<span class="token function">host</span>    replication     replicate      <span class="token number">192.168</span>.121.189/24          trust
 
 <span class="token number">4</span>. 重启
	pg_ctl restart 
 
</code></pre></div><ol start="2"><li>登录pg修改密码并创建用户</li></ol> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">alter</span> <span class="token keyword">user</span> postgres <span class="token keyword">with</span> password <span class="token string">'postgres'</span><span class="token punctuation">;</span>
<span class="token keyword">create</span> <span class="token keyword">user</span> replicate <span class="token keyword">with</span> <span class="token keyword">replication</span> password <span class="token string">'replicate'</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>从库配置</p></blockquote> <ol><li>使用 pgbasebackup 工具生成备库</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>pg_basebackup <span class="token parameter variable">-D</span> /home/postgres/pgdata <span class="token parameter variable">-R</span> <span class="token parameter variable">-Fp</span> <span class="token parameter variable">-Xs</span> <span class="token parameter variable">-v</span> <span class="token parameter variable">-P</span> <span class="token parameter variable">-h</span> <span class="token number">192.168</span>.6.52 <span class="token parameter variable">-p</span> <span class="token number">5432</span> <span class="token parameter variable">-U</span> replicate		<span class="token comment"># pgdata目录修改为自己的机器上的位置</span>
</code></pre></div><ol start="2"><li>启动备数据库，需提前将配置文件中的huge_pages关闭</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">vim</span> <span class="token variable">$PGDATA</span>/postgresql.conf
huge_pages <span class="token operator">=</span> off
</code></pre></div><ol start="3"><li>启动数据库</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>pg_ctl start
</code></pre></div><ol start="4"><li>运行<code>calc-hugePages.sh</code>程序，同样和主库一样获取<code>huge_pages</code>的值，然后写入到<code>sysctl.conf</code></li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>./calc-hugePages.sh
<span class="token builtin class-name">echo</span> <span class="token string">&quot;vm.nr_hugepages = 147&quot;</span><span class="token operator">&gt;&gt;</span>/etc/sysctl.conf
</code></pre></div><ol start="5"><li>查询是否添加成功</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">sysctl</span> <span class="token parameter variable">-p</span>
</code></pre></div><ol start="6"><li>重启数据库</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>pg_ctl restart
</code></pre></div><h3 id="_3-3-验证主从复制是否成功"><a href="#_3-3-验证主从复制是否成功" class="header-anchor">#</a> 3.3 验证主从复制是否成功</h3> <blockquote><p>主库登录检验</p></blockquote> <div class="language-sql extra-class"><pre class="language-sql"><code>psql
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> pg_stat_replication <span class="token punctuation">;</span>			<span class="token comment"># 查看复制状态</span>
</code></pre></div><p><img src="http://img.sweetbabywow.club/typoara/image-20220811152017867.png" alt="image-20220811152017867"></p> <h2 id="_4-安装pgbouncer"><a href="#_4-安装pgbouncer" class="header-anchor">#</a> 4. 安装pgbouncer</h2> <h3 id="_4-1-部署情况"><a href="#_4-1-部署情况" class="header-anchor">#</a> 4.1 部署情况</h3> <table><thead><tr><th>服务器ip</th> <th>部署情况</th></tr></thead> <tbody><tr><td>192.168.121.187（主库）</td> <td>pgbouncer</td></tr> <tr><td>192.168.121.189（备库）</td> <td>pgbouncer</td></tr></tbody></table> <h3 id="_4-2-相关依赖"><a href="#_4-2-相关依赖" class="header-anchor">#</a> 4.2 相关依赖</h3> <table><thead><tr><th>包名</th> <th>版本</th></tr></thead> <tbody><tr><td>libevent</td> <td>2.0.21</td></tr> <tr><td>pgbouncer</td> <td>1.8.1</td></tr></tbody></table> <h3 id="_4-3-安装libevent"><a href="#_4-3-安装libevent" class="header-anchor">#</a> 4.3 安装libevent</h3> <blockquote><p>在root用户下安装</p></blockquote> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token number">1</span>. 解压安装
	<span class="token function">mkdir</span> /usr/libevent
	<span class="token function">tar</span> <span class="token parameter variable">-zvxf</span> libevent-2.0.21-stable.tar.gz 
	<span class="token builtin class-name">cd</span> libevent-2.0.21-stable
	./configure <span class="token parameter variable">--prefix</span><span class="token operator">=</span>/usr/libevent
	<span class="token function">make</span> <span class="token parameter variable">-j4</span> <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span> <span class="token parameter variable">-j4</span>
</code></pre></div><h3 id="_4-4-安装pgbouncer"><a href="#_4-4-安装pgbouncer" class="header-anchor">#</a> 4.4 安装Pgbouncer</h3> <blockquote><p>在postgres用户下安装</p></blockquote> <ol><li>解压安装（在/home/postgres目录下）</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">tar</span> <span class="token parameter variable">-zvxf</span> pgbouncer-1.8.1.tar.gz
<span class="token builtin class-name">cd</span> pgbouncer-1.8.1
./configure <span class="token parameter variable">--prefix</span><span class="token operator">=</span>/home/postgres/pgbouncer --with-libevent<span class="token operator">=</span>/usr/libevent/
<span class="token function">make</span> <span class="token parameter variable">-j4</span> <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span> <span class="token parameter variable">-j4</span>
</code></pre></div><ol start="2"><li>手动创建log目录</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">mkdir</span> /home/postgres/pgbouncer/log
</code></pre></div><p>​	3. 修改配置文件</p> <div class="language-ini extra-class"><pre class="language-ini"><code>vi /home/postgres/pgbouncer/share/doc/pgbouncer/pgbouncer.ini

<span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">databases</span><span class="token punctuation">]</span></span>
<span class="token key attr-name">postgres</span> <span class="token punctuation">=</span> <span class="token value attr-value">host=172.16.245.4 port=7432 user=postgres password=postgresql pool_size=20</span>
<span class="token key attr-name">postgres</span> <span class="token punctuation">=</span> <span class="token value attr-value">host=172.16.245.5 port=7432 user=postgres password=postgresql pool_size=20</span>


<span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">pgbouncer</span><span class="token punctuation">]</span></span>
<span class="token key attr-name">listen_port</span> <span class="token punctuation">=</span> <span class="token value attr-value">6432</span>
<span class="token key attr-name">listen_addr</span> <span class="token punctuation">=</span> <span class="token value attr-value">*</span>
<span class="token comment">;unix_socket_dir = ''</span>
<span class="token comment">;user = postgres</span>
<span class="token key attr-name">auth_type</span> <span class="token punctuation">=</span> <span class="token value attr-value">md5</span>
<span class="token key attr-name">auth_file</span> <span class="token punctuation">=</span> <span class="token value attr-value">/home/postgres/pgbouncer/share/doc/pgbouncer/userlist.txt</span>
<span class="token key attr-name">logfile</span> <span class="token punctuation">=</span> <span class="token value attr-value">/home/postgres/pgbouncer/log/pgbouncer.log</span>
<span class="token key attr-name">pidfile</span> <span class="token punctuation">=</span> <span class="token value attr-value">/home/postgres/pgbouncer/log/pgbouncer.pid</span>
<span class="token key attr-name">admin_users</span> <span class="token punctuation">=</span> <span class="token value attr-value">postgres</span>
<span class="token key attr-name">stats_users</span> <span class="token punctuation">=</span> <span class="token value attr-value">mon</span>
<span class="token key attr-name">pool_mode</span> <span class="token punctuation">=</span> <span class="token value attr-value">session</span>
<span class="token key attr-name">client_idle_timeout</span><span class="token punctuation">=</span><span class="token value attr-value">10</span>
<span class="token key attr-name">server_idle_timeout</span><span class="token punctuation">=</span><span class="token value attr-value">1800</span>
<span class="token key attr-name">idle_transaction_timeout</span><span class="token punctuation">=</span><span class="token value attr-value">10</span>
<span class="token key attr-name">client_login_timeout</span><span class="token punctuation">=</span><span class="token value attr-value">10</span>
<span class="token key attr-name">server_reset_query</span> <span class="token punctuation">=</span> <span class="token value attr-value">DEALLOCATE ALL;</span>
<span class="token key attr-name">server_check_query</span> <span class="token punctuation">=</span> <span class="token value attr-value">select 1</span>
<span class="token key attr-name">server_check_delay</span> <span class="token punctuation">=</span> <span class="token value attr-value">10</span>
<span class="token key attr-name">reserve_pool_size</span> <span class="token punctuation">=</span> <span class="token value attr-value">5</span>
<span class="token key attr-name">reserve_pool_timeout</span> <span class="token punctuation">=</span> <span class="token value attr-value">5</span>
<span class="token key attr-name">max_client_conn</span> <span class="token punctuation">=</span> <span class="token value attr-value">50</span>
<span class="token key attr-name">default_pool_size</span> <span class="token punctuation">=</span> <span class="token value attr-value">20</span>
<span class="token key attr-name">log_connections</span> <span class="token punctuation">=</span> <span class="token value attr-value">0</span>
<span class="token key attr-name">log_disconnections</span> <span class="token punctuation">=</span> <span class="token value attr-value">0</span>
<span class="token key attr-name">log_pooler_errors</span> <span class="token punctuation">=</span> <span class="token value attr-value">1</span>
<span class="token key attr-name">ignore_startup_parameters</span> <span class="token punctuation">=</span> <span class="token value attr-value">extra_float_digits</span>

vi userlist.txt
&quot;postgres&quot; &quot;postgresql&quot;
</code></pre></div><ol start="4"><li>启动服务</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>/home/postgres/pgbouncer/bin/pgbouncer <span class="token parameter variable">-d</span> pgbouncer/share/doc/pgbouncer/pgbouncer.ini 
</code></pre></div><p>​	启动报错：pgbouncer: error while loading shared libraries: libevent-2.0.so.5: cannot open shared object file: No such file or directory解决方案如下:</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 添加至全局变量文件中</span>
<span class="token function">su</span> - 
<span class="token function">vi</span> /etc/profile
<span class="token builtin class-name">export</span> <span class="token assign-left variable">LD_LIBRARY_PATH</span><span class="token operator">=</span>/usr/libevent/lib:<span class="token variable">$LD_LIBRARY_PATH</span>   
<span class="token builtin class-name">source</span> /etc/profile
<span class="token comment"># 或者添加至用户变量 .bash_profile</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">PKG_CONFIG_PATH</span><span class="token operator">=</span>/home/postgres/libevent/lib/pkgconfig
</code></pre></div><ol start="5"><li><p>查看日志信息和服务器启动情况</p> <p>日志信息如下：<code>tail -f pgbouncer/log/pgbouncer.log</code></p></li></ol> <p><img src="http://img.sweetbabywow.club/typoara/image-20220811160122697.png" alt="image-20220811160122697"></p> <p>​	查看服务状态：<code>ps -elf |grep pgbouncer</code></p> <p><img src="http://img.sweetbabywow.club/typoara/image-20220811160358529.png" alt="image-20220811160358529"></p> <ol start="6"><li>确认是否可以登录</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>psql <span class="token parameter variable">-h</span> <span class="token number">192.168</span>.121.189 <span class="token parameter variable">-p</span> <span class="token number">6432</span> <span class="token parameter variable">-d</span> pgbouncer <span class="token parameter variable">-U</span> postgres
</code></pre></div><p><img src="http://img.sweetbabywow.club/typoara/image-20220811160704665.png" alt="image-20220811160704665"></p> <ol start="7"><li>查看池中的数据库 <code>show databases;</code></li></ol> <p><img src="http://img.sweetbabywow.club/typoara/image-20220811160753521.png" alt="image-20220811160753521"></p> <ol start="6"><li>查看连接数<code>show clients;</code></li></ol> <p><img src="http://img.sweetbabywow.club/typoara/image-20220811160832985.png" alt="image-20220811160832985"></p> <h2 id="_5-安装zookeeper"><a href="#_5-安装zookeeper" class="header-anchor">#</a> 5. 安装Zookeeper</h2> <h3 id="_5-1-部署情况"><a href="#_5-1-部署情况" class="header-anchor">#</a> 5.1 部署情况</h3> <table><thead><tr><th>服务器ip</th> <th>模式</th> <th>myid</th></tr></thead> <tbody><tr><td>192.168.121.187</td> <td>master</td> <td>3</td></tr> <tr><td>192.168.121.189</td> <td>follower</td> <td>2</td></tr> <tr><td>192.168.121.190</td> <td>follower</td> <td>1</td></tr></tbody></table> <h3 id="_5-2-下载路径及所装版本"><a href="#_5-2-下载路径及所装版本" class="header-anchor">#</a> 5.2 下载路径及所装版本</h3> <table><thead><tr><th>Zookeeper下载路径</th> <th>https://archive.apache.org/dist/zookeeper/zookeeper-3.4.13/zookeeper-3.4.13.tar.gz</th></tr></thead> <tbody><tr><td>Zookeeper 版本</td> <td>zookeeper-3.4.13.tar.gz</td></tr></tbody></table> <table><thead><tr><th>Java下载路径</th> <th>https://www.oracle.com/java/technologies/downloads/#java8</th></tr></thead> <tbody><tr><td>Java 版本</td> <td>jdk-8u341-linux-x64.tar.gz</td></tr></tbody></table> <h3 id="_5-3-安装java环境"><a href="#_5-3-安装java环境" class="header-anchor">#</a> 5.3 安装Java环境</h3> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 创建目录</span>
	<span class="token function">mkdir</span> /usr/java

<span class="token comment"># 解压</span>
	<span class="token function">tar</span> <span class="token parameter variable">-zvxf</span> jdk-8u341-linux-x64.tar.gz <span class="token parameter variable">-C</span> /usr/java/

<span class="token comment"># 添加环境变量</span>
    <span class="token function">vi</span> /etc/profile
        <span class="token comment">#set java environment</span>
        <span class="token assign-left variable">JAVA_HOME</span><span class="token operator">=</span>/usr/java/jdk1.8.0_341
        <span class="token assign-left variable">JRE_HOME</span><span class="token operator">=</span>/usr/java/jdk1.8.0_341/jre
        <span class="token assign-left variable">CLASS_PATH</span><span class="token operator">=</span>.:<span class="token variable">$JAVA_HOME</span>/lib/dt.jar:<span class="token variable">$JAVA_HOME</span>/lib/tools.jar:<span class="token variable">$JRE_HOME</span>/lib
        <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token environment constant">$PATH</span><span class="token builtin class-name">:</span><span class="token variable">$JAVA_HOME</span>/bin:<span class="token variable">$JRE_HOME</span>/bin
        <span class="token builtin class-name">export</span> JAVA_HOME JRE_HOME CLASS_PATH <span class="token environment constant">PATH</span>
    
<span class="token comment"># 重新加载环境变量</span>
	<span class="token builtin class-name">source</span> /etc/profile

<span class="token comment"># 测试</span>
	<span class="token function">java</span> <span class="token parameter variable">-version</span>
</code></pre></div><h3 id="_5-4-解压安装"><a href="#_5-4-解压安装" class="header-anchor">#</a> 5.4 解压安装</h3> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 安装目录 /home/postgres/zookeeper-3.4.13</span>
	<span class="token function">tar</span> <span class="token parameter variable">-zxvf</span> zookeeper-3.4.13.tar.gz

<span class="token comment"># 拷贝zoo.cfg</span>
    <span class="token builtin class-name">cd</span> /home/postgres/zookeeper-3.4.13/conf
    <span class="token function">cp</span> zoo.sample.cfg zoo.cfg

<span class="token comment"># 修改配置文件</span>
	<span class="token function">vim</span> zoo.cfg
        <span class="token assign-left variable">tickTime</span><span class="token operator">=</span><span class="token number">2000</span>
        server.1 <span class="token operator">=</span> <span class="token number">192.168</span>.121.189:2888:3888
        server.2 <span class="token operator">=</span> <span class="token number">192.168</span>.121.190:2888:3888
        server.3 <span class="token operator">=</span> <span class="token number">192.168</span>.121.187:2888:3888
        <span class="token assign-left variable">initLimit</span><span class="token operator">=</span><span class="token number">10</span>
        <span class="token assign-left variable">syncLimit</span><span class="token operator">=</span><span class="token number">5</span>
        <span class="token assign-left variable">dataDir</span><span class="token operator">=</span>/home/postgres/zookeeper-3.4.13/data
        <span class="token assign-left variable">clientPort</span><span class="token operator">=</span><span class="token number">2181</span>
        
<span class="token comment"># 创建 data log 目录</span>
	<span class="token function">mkdir</span> /home/postgres/zookeeper-3.4.13/data
	<span class="token function">mkdir</span> /home/postgres/zookeeper-3.4.13/log

<span class="token comment"># 创建 myid 文件 值越高选取为leader的优先级也越高</span>
	
	<span class="token comment"># 在192.168.121.187（主库）中</span>
	<span class="token builtin class-name">echo</span> <span class="token number">3</span> <span class="token operator">&gt;</span> /home/postgres/zookeeper-3.4.13/data/myid
	
	<span class="token comment"># 在192.168.121.189（备库）中</span>
	<span class="token builtin class-name">echo</span> <span class="token number">2</span> <span class="token operator">&gt;</span> /home/postgres/zookeeper-3.4.13/data/myid
	
	<span class="token comment"># 在192.168.121.190中</span>
	<span class="token builtin class-name">echo</span> <span class="token number">1</span> <span class="token operator">&gt;</span> /home/postgres/zookeeper-3.4.13/data/myid
	
	
<span class="token comment"># 为防火墙添加端口</span>
	firewall-cmd <span class="token parameter variable">--permanent</span> --add-port<span class="token operator">=</span><span class="token number">2888</span>/tcp
	firewall-cmd <span class="token parameter variable">--permanent</span> --add-port<span class="token operator">=</span><span class="token number">3888</span>/tcp
	firewall-cmd <span class="token parameter variable">--permanent</span> --add-port<span class="token operator">=</span><span class="token number">2181</span>/tcp
	firewall-cmd <span class="token parameter variable">--reload</span>
	
<span class="token comment"># 启动服务 (需要三台服务器启动服务)</span>
	/home/postgres/zookeeper-3.4.13/bin/zkServer.sh start
	
<span class="token comment"># 查看服务状态</span>
	/home/postgres/zookeeper-3.4.13/bin/zkServer.sh status
	
<span class="token comment"># 停止服务</span>
	/home/postgres/zookeeper-3.4.13/bin/zkServer.sh stop
	
<span class="token comment"># 重启服务</span>
	/home/postgres/zookeeper-3.4.13/bin/zkServer.sh restart
	
* 日志请在运行启动命令的目录下查看zookeeper.out文件
</code></pre></div><p>安装完成后服务状态如下：</p> <ul><li>主库</li></ul> <p><img src="http://img.sweetbabywow.club/typoara/image-20220812095438240.png" alt="image-20220812095438240"></p> <ul><li>从库</li></ul> <p><img src="http://img.sweetbabywow.club/typoara/image-20220812095733912.png" alt="image-20220812095733912"></p> <h2 id="_6-安装patroni"><a href="#_6-安装patroni" class="header-anchor">#</a> 6. 安装Patroni</h2> <h3 id="_6-1-部署情况"><a href="#_6-1-部署情况" class="header-anchor">#</a> 6.1 部署情况</h3> <table><thead><tr><th>服务器ip</th> <th>服务</th></tr></thead> <tbody><tr><td>192.168.121.187</td> <td>patroni</td></tr> <tr><td>192.168.121.189</td> <td>patroni</td></tr></tbody></table> <h3 id="_6-2-相关依赖"><a href="#_6-2-相关依赖" class="header-anchor">#</a> 6.2 相关依赖</h3> <table><thead><tr><th>patroni下载地址</th> <th>https://codeload.github.com/zalando/patroni/zip/1de7c78c04dab9882f6113815d377e6f3490d5dd</th></tr></thead> <tbody><tr><td>patroni版本</td> <td>patroni-1.4.4.zip</td></tr></tbody></table> <h3 id="_6-3-部署前准备"><a href="#_6-3-部署前准备" class="header-anchor">#</a> 6.3 部署前准备</h3> <ol><li>安装python相关包</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>yum <span class="token function">install</span> <span class="token parameter variable">-y</span> gcc epel-release
yum <span class="token function">install</span> <span class="token parameter variable">-y</span> python-pip python-psycopg2 python-devel

yum <span class="token function">install</span> <span class="token parameter variable">-y</span> python3-pip
yum <span class="token function">install</span> <span class="token parameter variable">-y</span> python36-devel

pip3 <span class="token function">install</span> <span class="token parameter variable">-upgrade</span> pip
</code></pre></div><ol start="2"><li>pip安装相关依赖</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>pip3 <span class="token function">install</span> urllib3 boto  psycopg2  requests  PyYAML six kazoo python-etcd python-consul  click prettytable  tzlocal python-dateutil psutil cdiff kubernetes psycopg2-binary patroni
</code></pre></div><blockquote><p>在本步骤出现Time out报错的时候，大多数情况是因为网络原因导致的</p></blockquote> <h3 id="_6-4-解压安装"><a href="#_6-4-解压安装" class="header-anchor">#</a> 6.4 解压安装</h3> <blockquote><p>使用postgres用户进行解压安装</p></blockquote> <ol><li>wget下载的包名需要进行修改</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">wget</span> https://codeload.github.com/zalando/patroni/zip/1de7c78c04dab9882f6113815d377e6f3490d5dd

<span class="token function">mv</span> 1de7c78c04dab9882f6113815d377e6f3490d5dd patroni-1.4.4.zip
</code></pre></div><div class="language- extra-class"><pre><code>2. 压缩格式为zip,需要安装unzip解压工具
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code>yum <span class="token function">install</span> <span class="token parameter variable">-y</span> <span class="token function">unzip</span>
</code></pre></div><ol start="3"><li>解压安装（路径为/home/postgres/）</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 解压</span>
	<span class="token function">unzip</span> partoni-1.4.4.zip

<span class="token comment"># 修改 postgres0.yml 配置文件</span>
	<span class="token builtin class-name">cd</span> patroni-1.4.4.zip
	<span class="token function">vi</span> postgres0.yml
		scope: batmant1
        <span class="token comment">#namespace: /service/</span>
        name: node_192_168_121_187

        restapi:
          listen: <span class="token number">192.168</span>.121.187:8009
          connect_address: <span class="token number">192.168</span>.121.187:8009
        <span class="token comment">#  certfile: /etc/ssl/certs/ssl-cert-snakeoil.pem</span>
        <span class="token comment">#  keyfile: /etc/ssl/private/ssl-cert-snakeoil.key</span>
        <span class="token comment">#  authentication:</span>
        <span class="token comment">#    username: username</span>
        <span class="token comment">#    password: password</span>

        <span class="token comment"># ctl:</span>
        <span class="token comment">#   insecure: false # Allow connections to SSL sites without certs</span>
        <span class="token comment">#   certfile: /etc/ssl/certs/ssl-cert-snakeoil.pem</span>
        <span class="token comment">#   cacert: /etc/ssl/certs/ssl-cacert-snakeoil.pem</span>

        zookeeper:
          hosts: <span class="token string">'192.168.121.187:2181,192.168.121.189:2181,192.168.121.190:2181'</span>

        bootstrap:
          <span class="token comment"># this section will be written into Etcd:/&lt;namespace&gt;/&lt;scope&gt;/config after initializing new cluster</span>
          <span class="token comment"># and all other cluster members will use it as a `global configuration`</span>
          dcs:
            ttl: <span class="token number">30</span>
            loop_wait: <span class="token number">10</span>
            retry_timeout: <span class="token number">10</span>
            maximum_lag_on_failover: <span class="token number">1048576</span>
        <span class="token comment">#    master_start_timeout: 300</span>
        <span class="token comment">#    synchronous_mode: false</span>
        <span class="token comment">#    standby_cluster:</span>
        <span class="token comment">#      host: 192.168.191.143</span>
        <span class="token comment">#      port: 5432</span>
        <span class="token comment">#      primary_slot_name: node_192_168_191_141_ss</span>
            postgresql:
              use_pg_rewind: <span class="token boolean">true</span>
        <span class="token comment">#      use_slots: true</span>
              parameters:
        <span class="token comment">#       shared_preload_libraries: 'pg_pathman'</span>
        <span class="token comment">#        wal_level: hot_standby</span>
        <span class="token comment">#        hot_standby: &quot;on&quot;</span>
                wal_keep_segments: <span class="token number">8</span>
                max_wal_senders: <span class="token number">10</span>
                max_replication_slots: <span class="token number">10</span>
        <span class="token comment">#        wal_log_hints: &quot;on&quot;</span>
               max_connections: <span class="token number">1000</span>
               archive_mode: <span class="token string">&quot;off&quot;</span>
        <span class="token comment">#        archive_timeout: 1800s</span>
        <span class="token comment">#        archive_command: mkdir -p ../wal_archive &amp;&amp; test ! -f ../wal_archive/%f &amp;&amp; cp %p ../wal_archive/%f</span>
        <span class="token comment">#      recovery_conf:</span>
        <span class="token comment">#        restore_command: cp ../wal_archive/%f %p</span>

          <span class="token comment"># some desired options for 'initdb'</span>
          initdb:  <span class="token comment"># Note: It needs to be a list (some options need values, others are switches)</span>
          - encoding: UTF8
          - data-checksums

          pg_hba:  <span class="token comment"># Add following lines to pg_hba.conf after running 'initdb'</span>
          - <span class="token function">host</span> replication replicate <span class="token number">127.0</span>.0.1/32 trust
          - <span class="token function">host</span> all all <span class="token number">0.0</span>.0.0/0 md5
          - <span class="token function">host</span> replication all <span class="token number">192.168</span>.121.189/32 trust
          - <span class="token function">host</span> replication all <span class="token number">192.168</span>.121.187/32 trust 
        <span class="token comment">#  - hostssl all all 0.0.0.0/0 md5</span>

          <span class="token comment"># Additional script to be launched after initial cluster creation (will be passed the connection URL as parameter)</span>
        <span class="token comment"># post_init: /usr/local/bin/setup_cluster.sh</span>

          <span class="token comment"># Some additional users users which needs to be created after initializing new cluster</span>
          users:
            admin:
              password: admin
              options:
                - createrole
                - createdb

        postgresql:
          listen: <span class="token number">0.0</span>.0.0:5432
          connect_address: <span class="token number">192.168</span>.121.187:5432
          data_dir: /data/pgsql/10.5/pgdata/
        <span class="token comment">#  bin_dir:</span>
        <span class="token comment">#  config_dir:</span>
          pgpass: /home/postgres/.pgpass
          authentication:
            replication:
              username: replicate
              password: <span class="token string">'replicate'</span>
            superuser:
              username: postgres
              password: <span class="token string">'postgresql'</span>
          parameters:
            unix_socket_directories: <span class="token string">'/home/postgres'</span>

        <span class="token comment">#watchdog:</span>
        <span class="token comment">#  mode: automatic # Allowed values: off, automatic, required</span>
        mode: off
        <span class="token comment">#  device: /dev/watchdog</span>
        <span class="token comment">#  safety_margin: 5</span>

        tags:
            nofailover: <span class="token boolean">false</span>
            noloadbalance: <span class="token boolean">false</span>
            clonefrom: <span class="token boolean">false</span>
            nosync: <span class="token boolean">false</span>
</code></pre></div><h3 id="_6-5-启动patroni服务"><a href="#_6-5-启动patroni服务" class="header-anchor">#</a> 6.5 启动Patroni服务</h3> <ol><li>后台启动</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">nohup</span> patroni postgres0.yml <span class="token operator">&gt;</span> postgres0.log <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">&amp;</span>
</code></pre></div><ol start="2"><li>查看服务状态</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">ps</span> <span class="token parameter variable">-ef</span> <span class="token operator">|</span> <span class="token function">grep</span> patroni
</code></pre></div><blockquote><p>日志文件保存在postgres0.log中</p></blockquote> <h4 id="_6-5-1-追踪日志信息"><a href="#_6-5-1-追踪日志信息" class="header-anchor">#</a> 6.5.1 追踪日志信息</h4> <ul><li>主库</li></ul> <p><img src="http://img.sweetbabywow.club/typoara/image-20220812100205912.png" alt="image-20220812100205912"></p> <ul><li>备库</li></ul> <p><img src="http://img.sweetbabywow.club/typoara/image-20220812100243352.png" alt="image-20220812100243352"></p> <h4 id="_6-5-2-常见问题"><a href="#_6-5-2-常见问题" class="header-anchor">#</a> 6.5.2 常见问题</h4> <p>在postgres0.log中可以看到启动及错误信息，</p> <ul><li>如出现refuse connection 首先检查配置文件中的服务端口8009是否在防护墙放行。</li> <li>出现pg相关的报错检查pg数据库是否启动，配置文件中的相关信息是否正确。</li> <li>出现python相关的报错检查相关依赖是否安装和升级。</li></ul> <h3 id="_6-6-patroni-主备切换"><a href="#_6-6-patroni-主备切换" class="header-anchor">#</a> 6.6 Patroni 主备切换</h3> <h4 id="_6-6-1-查看patroni主备信息"><a href="#_6-6-1-查看patroni主备信息" class="header-anchor">#</a> 6.6.1 查看patroni主备信息</h4> <div class="language-shell extra-class"><pre class="language-shell"><code>patronictl <span class="token parameter variable">-c</span> /home/postgres/patroni-1.4.4/postgres0.yml list batmant1
</code></pre></div><p><img src="http://img.sweetbabywow.club/typoara/image-20220812100453567.png" alt="image-20220812100453567"></p> <h4 id="_6-6-2-手动进行主备切换"><a href="#_6-6-2-手动进行主备切换" class="header-anchor">#</a> 6.6.2 手动进行主备切换</h4> <div class="language-shell extra-class"><pre class="language-shell"><code>patronictl <span class="token parameter variable">-c</span> /home/postgres/patroni-1.4.4/postgres0.yml switchover
</code></pre></div><p><img src="http://img.sweetbabywow.club/typoara/image-20220812100727716.png" alt="image-20220812100727716"></p> <h4 id="_6-2-3-查看切换信息"><a href="#_6-2-3-查看切换信息" class="header-anchor">#</a> 6.2.3 查看切换信息</h4> <ul><li>查看主库的状态（已经转为备库）</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code>pg_controldata <span class="token operator">|</span> <span class="token function">grep</span> state
</code></pre></div><p><img src="http://img.sweetbabywow.club/typoara/image-20220812105240145.png" alt="image-20220812105240145"></p> <ul><li>查看备库的状态（已经转为主库）</li></ul> <p><img src="http://img.sweetbabywow.club/typoara/image-20220812105849631.png" alt="image-20220812105849631"></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/mysql/MySQL简介.html" class="prev">
        What is MySQL?
      </a></span> <span class="next"><a href="/ha/Patroni总结.html">
        Patroni
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.4e56e56e.js" defer></script><script src="/assets/js/2.3dc1b8de.js" defer></script><script src="/assets/js/1.7f771cfb.js" defer></script><script src="/assets/js/24.f176594d.js" defer></script>
  </body>
</html>
